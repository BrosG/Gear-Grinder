<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>GEAR GRINDER â€” PATCHED EDITION</title>
<!-- MQTT Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Bebas+Neue&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#05070a;overflow:hidden;font-family:'Rajdhani',sans-serif;color:#fff;touch-action:none;user-select:none;-webkit-user-select:none}
canvas{display:block;outline:none}

/* --- HUD & UI LAYERS --- */
#vignette{position:fixed;inset:0;pointer-events:none;background:radial-gradient(ellipse at 50% 60%,transparent 35%,#000000cc 85%,#000 100%);z-index:5}
#terrain-tint{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity 1.5s,background 1.5s;z-index:4}
#speed-lines{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .3s;z-index:4;background:radial-gradient(ellipse at 50% 50%,transparent 30%,rgba(255,255,255,.02) 60%,transparent 61%);mix-blend-mode:screen}
#flash-overlay{position:fixed;inset:0;pointer-events:none;z-index:20;opacity:0;transition:opacity .08s}
#shift-flash{position:fixed;inset:0;pointer-events:none;opacity:0;z-index:9;transition:opacity .2s ease-out}
#shift-flash.up{background:linear-gradient(to top,transparent 30%,#4dffb822 60%,#4dffb844 100%)}
#shift-flash.down{background:linear-gradient(to bottom,transparent 30%,#4db8ff22 60%,#4db8ff44 100%)}
#shift-hint{position:absolute;top:23%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',monospace;font-size:14px;color:#ff4d4d;text-shadow:0 0 15px #ff4d4d88;opacity:0;transition:opacity .3s;z-index:15;pointer-events:none;letter-spacing:6px;font-weight:900}

/* --- HUD ELEMENTS --- */
#hud{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:10;display:none}
#hud>*{pointer-events:auto}
.hud-score{position:absolute;top:10px;left:50%;transform:translateX(-50%);text-align:center}
.hud-score-label{font-size:9px;letter-spacing:6px;color:#ffb84d44;text-transform:uppercase;font-family:'Orbitron'}
.hud-score-val{font-family:'Bebas Neue',monospace;font-size:44px;background:linear-gradient(180deg,#fff,#ffb84d 50%,#ff6b3d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1;transition:transform .05s;letter-spacing:2px}
.hud-score-val.bump{transform:scale(1.15)}
#combo-bar{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:#4dffb8;opacity:0;transition:opacity .3s;text-shadow:0 0 12px currentColor;letter-spacing:3px}
#combo-bar.on{opacity:1}
.hud-dist{position:absolute;top:12px;left:14px}
.hud-dist-val{font-family:'Orbitron',monospace;font-size:15px;color:#ffffffaa}
.hud-dist-unit{font-size:8px;color:#ffffff33;letter-spacing:4px;font-family:'Orbitron'}
.hud-best{position:absolute;top:12px;right:14px;text-align:right}
.hud-best-label{font-size:8px;letter-spacing:4px;color:#ffb84d33;font-family:'Orbitron'}
.hud-best-val{font-family:'Orbitron',monospace;font-size:13px;color:#ffb84d66}
.hud-speed{position:absolute;bottom:18px;left:14px}
.hud-speed-val{font-family:'Bebas Neue',monospace;font-size:56px;color:#fff;line-height:1;transition:color .2s;letter-spacing:2px}
.hud-speed-unit{font-size:10px;letter-spacing:4px;color:#ffffff33;font-family:'Orbitron'}
.hud-gear{position:absolute;bottom:18px;right:14px;text-align:right}
.hud-gear-label{font-size:8px;letter-spacing:6px;color:#4db8ff44;font-family:'Orbitron'}
.hud-gear-val{font-family:'Bebas Neue',monospace;font-size:60px;color:#4db8ff;line-height:1;display:inline-block;transition:color .2s}
.hud-gear-val.shift-up{animation:gearUp .25s cubic-bezier(.34,1.56,.64,1)}
.hud-gear-val.shift-down{animation:gearDown .25s cubic-bezier(.34,1.56,.64,1)}
@keyframes gearUp{0%{transform:translateY(12px) scale(.7);opacity:0}100%{transform:translateY(0) scale(1);opacity:1}}
@keyframes gearDown{0%{transform:translateY(-12px) scale(.7);opacity:0}100%{transform:translateY(0) scale(1);opacity:1}}
.hud-gear-name{font-size:10px;color:#4db8ff55;letter-spacing:3px;font-family:'Orbitron'}
.hud-incline{position:absolute;top:65px;right:14px;text-align:right}
.hud-incline-label{font-size:8px;letter-spacing:4px;color:#ffffff22;font-family:'Orbitron'}
.hud-incline-val{font-family:'Orbitron',monospace;font-size:22px;font-weight:700;line-height:1;transition:color .8s}
.hud-rpm-wrap{position:absolute;right:14px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:6px}
.hud-rpm-bar{width:22px;height:200px;background:#ffffff06;border:1px solid #ffffff0a;border-radius:11px;overflow:hidden;position:relative}
.hud-rpm-fill{position:absolute;bottom:0;left:0;right:0;border-radius:0 0 11px 11px;transition:height .1s ease-out}
.hud-rpm-sweet{position:absolute;left:-2px;right:-2px;border:2px solid #4dffb844;border-radius:3px;background:#4dffb806;z-index:2}
.hud-rpm-redline{position:absolute;left:0;right:0;top:0;height:15%;background:linear-gradient(to bottom,#ff4d4d22,transparent);border-radius:11px 11px 0 0}
.hud-rpm-text{font-size:8px;letter-spacing:5px;color:#ffffff18;writing-mode:vertical-rl;font-family:'Orbitron'}
.hud-energy-wrap{position:absolute;left:14px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:6px}
.hud-energy-bar{width:22px;height:200px;background:#ffffff06;border:1px solid #ffffff0a;border-radius:11px;overflow:hidden;position:relative;transition:border-color .3s,box-shadow .3s}
.hud-energy-bar.low{border-color:#ff4d4d88;box-shadow:0 0 15px #ff4d4d33;animation:eLow 1s infinite}
@keyframes eLow{50%{box-shadow:0 0 25px #ff4d4d55}}
.hud-energy-fill{position:absolute;bottom:0;left:0;right:0;border-radius:0 0 11px 11px;transition:height .15s ease-out;background:linear-gradient(to top,#ff4d4d,#ffb84d 40%,#4dffb8)}
.hud-energy-text{font-size:8px;letter-spacing:5px;color:#ffffff18;writing-mode:vertical-rl;font-family:'Orbitron'}
.hud-pedal-ring{position:absolute;bottom:85px;left:50%;transform:translateX(-50%);width:90px;height:90px;pointer-events:auto}
.pedal-ring-svg{width:100%;height:100%}
.pedal-ring-bg{fill:none;stroke:#ffffff06;stroke-width:3}
.pedal-ring-progress{fill:none;stroke:#ff6b3d;stroke-width:3.5;stroke-linecap:round;transition:stroke-dashoffset .06s linear;filter:drop-shadow(0 0 8px #ff6b3d44)}
.pedal-ring-ideal{fill:none;stroke:#4dffb833;stroke-width:6;stroke-linecap:round}
.pedal-btn-inner{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:58px;height:58px;border-radius:50%;background:radial-gradient(circle,#ff6b3d22,#ff6b3d05);border:1.5px solid #ff6b3d33;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:#ff6b3d77;cursor:pointer;transition:all .06s;-webkit-tap-highlight-color:transparent}
.pedal-btn-inner:active,.pedal-btn-inner.pressed{background:radial-gradient(circle,#ff6b3d55,#ff6b3d15);border-color:#ff6b3dcc;transform:translate(-50%,-50%) scale(.88);color:#ff6b3dcc}
#float-text{position:absolute;left:50%;top:36%;transform:translate(-50%,-50%);font-family:'Orbitron',monospace;font-size:22px;font-weight:900;opacity:0;text-shadow:0 0 25px currentColor,0 0 50px currentColor;pointer-events:none;transition:opacity .2s,transform .35s;white-space:nowrap;z-index:12;letter-spacing:3px}
#float-text.show{opacity:1;transform:translate(-50%,-60%)}
#cliff-warn{position:absolute;left:50%;bottom:190px;transform:translateX(-50%);font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:#ff6633;letter-spacing:5px;opacity:0;transition:opacity .5s;white-space:nowrap;text-shadow:0 0 20px #ff440066;padding:6px 18px;background:linear-gradient(to right,transparent,#ff440011,transparent);border-radius:4px}
#cliff-warn.show{opacity:1}
@keyframes blink{50%{opacity:.15}}
#powerup-status{position:absolute;top:80px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;opacity:0;transition:opacity .3s;background:#ffffff08;padding:4px 14px;border-radius:20px;border:1px solid #ffffff11}
#powerup-status.show{opacity:1}
.pu-icon{font-size:20px}.pu-label{font-family:'Orbitron',monospace;font-size:11px;letter-spacing:2px}.pu-timer{font-family:'Bebas Neue';font-size:18px}
#zone-banner{position:absolute;left:50%;top:26%;transform:translate(-50%,-50%);text-align:center;opacity:0;pointer-events:none;transition:opacity .6s}
#zone-banner.show{opacity:1}
.zone-name{font-family:'Bebas Neue',monospace;font-size:32px;letter-spacing:8px;text-shadow:0 0 30px currentColor}
.zone-sub{font-size:10px;letter-spacing:10px;margin-top:2px;opacity:.3;font-family:'Orbitron'}

/* --- START SCREEN --- */
#start-screen{position:fixed;inset:0;z-index:100;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#06080e;overflow:hidden}
.bg-grid{position:absolute;inset:0;pointer-events:none;background-image:linear-gradient(#ffffff05 1px,transparent 1px),linear-gradient(90deg,#ffffff05 1px,transparent 1px);background-size:40px 40px;animation:gridScroll 4s linear infinite}
@keyframes gridScroll{from{background-position:0 0}to{background-position:0 40px}}
.bg-glow{position:absolute;top:30%;left:50%;transform:translate(-50%,-50%);width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,#ff6b3d11,transparent 60%);pointer-events:none;animation:glowP 3s ease-in-out infinite alternate}
@keyframes glowP{from{transform:translate(-50%,-50%) scale(1);opacity:.6}to{transform:translate(-50%,-50%) scale(1.2);opacity:1}}
#start-content{z-index:1;text-align:center;padding:30px}
#start-screen h1{font-family:'Bebas Neue',monospace;font-size:72px;letter-spacing:12px;background:linear-gradient(180deg,#fff,#ffb84d 40%,#ff6b3d 70%,#ff4d8b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1}
.start-edition{font-family:'Orbitron';font-size:11px;letter-spacing:12px;color:#ff6b3d66;margin-bottom:28px}
.start-controls{text-align:left;margin:0 auto 28px;max-width:440px;color:#ffffff66;font-size:12px;line-height:1.8;display:grid;grid-template-columns:auto 1fr;gap:6px 16px;background:#ffffff04;padding:18px 22px;border-radius:12px;border:1px solid #ffffff08}
.start-controls .key{color:#ffb84d;font-weight:700;font-family:'Orbitron';font-size:10px;text-align:right;white-space:nowrap}
.start-controls .sep{grid-column:1/-1;border-top:1px solid #ffffff08;margin:4px 0}
.start-tip{grid-column:1/-1;text-align:center;color:#4dffb888;font-size:10px;font-family:'Orbitron';letter-spacing:2px;padding-top:6px}

/* Room Input */
.room-input{background:#ffffff11;border:1px solid #ffffff33;padding:12px;color:#4dffb8;font-family:'Orbitron';text-transform:uppercase;text-align:center;margin:0 0 15px 0;width:240px;font-size:16px;border-radius:50px;letter-spacing:2px;outline:none;transition:all .3s}
.room-input:focus{background:#ffffff1a;border-color:#4dffb8;box-shadow:0 0 15px #4dffb833}

#start-btn{padding:14px 60px;border:1.5px solid #ff6b3d55;border-radius:50px;background:#ff6b3d0a;color:#ff6b3d;font-family:'Bebas Neue',monospace;font-size:22px;letter-spacing:8px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
#start-btn:hover{background:#ff6b3d1a;border-color:#ff6b3d99;box-shadow:0 0 40px #ff6b3d22}
#start-btn:disabled{opacity:0.5;cursor:wait;filter:grayscale(1)}
#start-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,#ff6b3d22,transparent);transform:translateX(-100%);animation:btnShine 2.5s infinite}
@keyframes btnShine{0%,70%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

/* --- LOBBY SCREEN --- */
#lobby-screen{position:fixed;inset:0;z-index:200;display:none;flex-direction:column;align-items:center;justify-content:center;background:#06080eee;backdrop-filter:blur(20px)}
#lobby-screen.show{display:flex}
.lobby-header{font-family:'Bebas Neue';font-size:40px;color:#fff;margin-bottom:10px;text-shadow:0 0 20px #ffffff44}
.lobby-room-code{font-family:'Orbitron';font-size:18px;color:#4dffb8;margin-bottom:30px;letter-spacing:4px;background:#4dffb811;padding:8px 24px;border-radius:30px;border:1px solid #4dffb844}
.lobby-list{width:320px;min-height:150px;max-height:300px;background:#00000066;border:1px solid #ffffff22;padding:15px;margin-bottom:30px;border-radius:12px;overflow-y:auto}
.lobby-player{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ffffff08;padding:10px 0;font-family:'Rajdhani';font-size:14px;letter-spacing:1px;color:#ffffffaa}
.lobby-player:last-child{border-bottom:none}
.lobby-player strong{color:#fff;font-weight:700}
.lobby-player.me strong{color:#ffb84d}
.lobby-player .status{font-size:10px;font-family:'Orbitron';color:#4dffb8}
#lobby-start-btn{padding:12px 50px;border:1.5px solid #4dffb8;border-radius:30px;background:#4dffb811;color:#4dffb8;font-family:'Orbitron';font-weight:700;font-size:12px;letter-spacing:2px;cursor:pointer;transition:all .3s}
#lobby-start-btn:hover{background:#4dffb833;box-shadow:0 0 25px #4dffb855}
.lobby-wait-msg{margin-top:15px;color:#ffffff44;font-size:10px;font-family:'Orbitron';letter-spacing:2px}

/* --- COUNTDOWN --- */
#countdown-overlay{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;font-family:'Bebas Neue';font-size:250px;color:#fff;text-shadow:0 0 50px #ff4d8b;pointer-events:none;background:#00000088}

/* --- GAME OVER --- */
#go-screen{position:fixed;inset:0;z-index:100;display:none;flex-direction:column;align-items:center;justify-content:center;background:#06080eee;backdrop-filter:blur(16px)}
#go-screen.show{display:flex}
#go-screen h2{font-family:'Bebas Neue',monospace;font-size:40px;letter-spacing:8px;color:#ff4d4d;margin-bottom:4px;text-shadow:0 0 30px #ff4d4d44}
.go-grade-wrap{margin:8px 0 16px}
.go-grade-label{font-size:9px;letter-spacing:5px;color:#ffffff33;text-align:center;font-family:'Orbitron'}
.go-grade-val{font-family:'Bebas Neue',monospace;font-size:90px;line-height:1;text-shadow:0 0 40px currentColor;transform:scale(0);transition:transform .5s cubic-bezier(.175,.885,.32,1.275)}
.go-grade-val.pop{transform:scale(1)}
.go-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px 24px;margin-bottom:14px}
.go-stat{font-family:'Orbitron',monospace;font-size:10px;color:#ffffff33;letter-spacing:2px;opacity:0;transform:translateY(8px);transition:all .3s}
.go-stat.show{opacity:1;transform:translateY(0)}
.go-stat strong{color:#ffffffcc;font-size:16px;margin-left:6px;font-family:'Bebas Neue'}
.go-score{font-family:'Bebas Neue',monospace;font-size:48px;letter-spacing:3px;background:linear-gradient(180deg,#fff,#ffb84d,#ff6b3d);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:8px 0}
.go-hs{color:#4dffb888;font-family:'Orbitron',monospace;font-size:11px;margin-bottom:16px;letter-spacing:2px}
.go-new{color:#4dffb8;font-family:'Orbitron',monospace;font-size:13px;letter-spacing:6px;animation:flash .5s infinite alternate;margin-bottom:4px}
@keyframes flash{from{opacity:.3}to{opacity:1;text-shadow:0 0 20px #4dffb866}}
.go-btns{display:flex;gap:8px}.go-btn{padding:10px 26px;border-radius:50px;font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:3px;cursor:pointer;transition:all .3s;border:1.5px solid}
#retry-btn{background:#ff6b3d0a;border-color:#ff6b3d55;color:#ff6b3d}#retry-btn:hover{background:#ff6b3d22}
#share-btn{background:#4db8ff0a;border-color:#4db8ff55;color:#4db8ff}#share-btn:hover{background:#4db8ff22}

#toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:#4dffb80e;border:1px solid #4dffb833;color:#4dffb8;padding:6px 20px;border-radius:30px;font-family:'Orbitron',monospace;font-size:10px;letter-spacing:3px;opacity:0;transition:opacity .4s;z-index:400;pointer-events:none}
#toast.show{opacity:1}
@media(max-width:600px){.hud-score-val{font-size:32px}.hud-speed-val{font-size:40px}.hud-gear-val{font-size:44px}#start-screen h1{font-size:42px;letter-spacing:6px}.hud-rpm-bar,.hud-energy-bar{height:150px;width:18px}.go-score{font-size:36px}.go-grade-val{font-size:70px}}
</style>
</head>
<body>
<div id="vignette"></div><div id="terrain-tint"></div><div id="speed-lines"></div><div id="flash-overlay"></div><div id="shift-flash"></div><div id="shift-hint"></div>

<!-- START SCREEN -->
<div id="start-screen"><div class="bg-grid"></div><div class="bg-glow"></div><div id="start-content">
<h1>GEAR GRINDER</h1><div class="start-edition">MULTIPLAYER EDITION</div>
<input type="text" id="room-input" class="room-input" placeholder="ENTER ROOM NAME" value="RACE1">
<div class="start-controls">
<span class="key">SPACE / TAP</span><span>Pedal â€” rhythm is everything</span>
<span class="key">â†‘ â†“ / SCROLL</span><span>Shift through 12 gears</span>
<span class="key">â† â†’ / SWIPE</span><span>Dodge obstacles & grab powerups</span>
<div class="sep"></div>
<span class="key">âš¡ğŸ”¥âœ¨ğŸª¶</span><span>Energy Â· Speed Â· Score Â· Gravity</span>
</div><button id="start-btn">ENTER LOBBY</button></div></div>

<!-- LOBBY SCREEN -->
<div id="lobby-screen">
  <div class="lobby-header">MULTIPLAYER LOBBY</div>
  <div class="lobby-room-code" id="lobby-room-display">ROOM: RACE1</div>
  <div class="lobby-list" id="lobby-list">
    <!-- Players populate here -->
  </div>
  <button id="lobby-start-btn">START RACE</button>
  <div class="lobby-wait-msg">ANYONE CAN START THE RACE</div>
</div>

<!-- COUNTDOWN -->
<div id="countdown-overlay">3</div>

<!-- GAME OVER -->
<div id="go-screen"><div class="go-new" id="go-new" style="display:none">â˜… NEW RECORD â˜…</div>
<h2>WIPEOUT</h2><div class="go-grade-wrap"><div class="go-grade-label">PERFORMANCE</div><div class="go-grade-val" id="go-grade">A</div></div>
<div class="go-grid">
<div class="go-stat">DISTANCE<strong id="go-dist">0</strong></div><div class="go-stat">MAX SPEED<strong id="go-maxspd">0</strong></div>
<div class="go-stat">PERFECTS<strong id="go-perfect">0</strong></div><div class="go-stat">CLIFFS<strong id="go-cliffs">0</strong></div>
<div class="go-stat">TOP GEAR<strong id="go-topgear">1</strong></div><div class="go-stat">BEST COMBO<strong id="go-combo">0</strong></div>
</div><div class="go-score" id="go-score">0</div><div class="go-hs" id="go-hs">HIGH SCORE: 0</div>
<div class="go-btns"><button class="go-btn" id="retry-btn">RETRY</button><button class="go-btn" id="share-btn">SHARE</button></div></div>

<!-- HUD -->
<div id="hud">
<div class="hud-score"><div class="hud-score-label">SCORE</div><div class="hud-score-val" id="h-score">0</div><div id="combo-bar">COMBO Ã—1</div></div>
<div id="powerup-status"><span class="pu-icon" id="pu-icon"></span><span class="pu-label" id="pu-label"></span><span class="pu-timer" id="pu-timer"></span></div>
<div class="hud-dist"><div class="hud-dist-val" id="h-dist">0</div><div class="hud-dist-unit">METERS</div></div>
<div class="hud-best"><div class="hud-best-label">BEST</div><div class="hud-best-val" id="h-best">0</div></div>
<div class="hud-speed"><div class="hud-speed-val" id="h-speed">0</div><div class="hud-speed-unit">KM/H</div></div>
<div class="hud-gear"><div class="hud-gear-label">GEAR</div><div class="hud-gear-val" id="h-gear">1</div><div class="hud-gear-name" id="h-gname">EASY</div></div>
<div class="hud-incline"><div class="hud-incline-label">GRADIENT</div><div class="hud-incline-val" id="h-incline">0%</div></div>
<div class="hud-rpm-wrap"><div class="hud-rpm-text">R P M</div><div class="hud-rpm-bar"><div class="hud-rpm-redline"></div><div class="hud-rpm-fill" id="rpm-fill"></div><div class="hud-rpm-sweet" id="rpm-sweet"></div></div></div>
<div class="hud-energy-wrap"><div class="hud-energy-bar" id="energy-bar-el"><div class="hud-energy-fill" id="energy-fill"></div></div><div class="hud-energy-text">E N R G Y</div></div>
<div class="hud-pedal-ring"><svg class="pedal-ring-svg" viewBox="0 0 100 100"><circle class="pedal-ring-bg" cx="50" cy="50" r="44"/><circle class="pedal-ring-ideal" id="pedal-ideal-arc" cx="50" cy="50" r="44" stroke-dasharray="276.5" stroke-dashoffset="220" transform="rotate(-90 50 50)"/><circle class="pedal-ring-progress" id="pedal-progress" cx="50" cy="50" r="44" stroke-dasharray="276.5" stroke-dashoffset="276.5" transform="rotate(-90 50 50)"/></svg><div class="pedal-btn-inner" id="pedal-btn">PEDAL</div></div>
<div id="float-text"></div><div id="cliff-warn">âš  CLIFF AHEAD âš </div>
<div id="zone-banner"><div class="zone-name" id="z-name"></div><div class="zone-sub" id="z-sub"></div></div>
</div>
<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
"use strict";
// Helper: set props on mesh without Object.assign (position/rotation/scale are read-only)
function mp(mesh, props) {
  if (props.position) { mesh.position.set(props.position.x, props.position.y, props.position.z); delete props.position; }
  if (props.rotation) { mesh.rotation.set(props.rotation.x, props.rotation.y, props.rotation.z); delete props.rotation; }
  if (props.scale) { mesh.scale.set(props.scale.x, props.scale.y, props.scale.z); delete props.scale; }
  if (props.castShadow !== undefined) { mesh.castShadow = props.castShadow; delete props.castShadow; }
  if (props.receiveShadow !== undefined) { mesh.receiveShadow = props.receiveShadow; delete props.receiveShadow; }
  return mesh;
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LANE_W=2.2,LANES=[-LANE_W,0,LANE_W],RW=8;
const RSL=4,SEG_LEN=8.0,RCOUNT=120,ROAD_DRAW_DIST=RCOUNT*RSL;
const SHOULDER_W=1.2,CURB_H=.08;
const POWERUPS=[
  {type:'ENERGY',color:0x4dffb8,icon:'âš¡',dur:0,msg:'âš¡ ENERGY BOOST'},
  {type:'SPEED',color:0xff6b3d,icon:'ğŸ”¥',dur:6,msg:'ğŸ”¥ SPEED BURST'},
  {type:'SCORE',color:0xffcc00,icon:'âœ¨',dur:8,msg:'âœ¨ DOUBLE POINTS'},
  {type:'GRAVITY',color:0x4db8ff,icon:'ğŸª¶',dur:7,msg:'ğŸª¶ FEATHERWEIGHT'},
];
const GEARS=[null,
  {name:'EASY',ratio:.55,sMin:.15,sMax:.80,bpm:200,top:15,eCost:.003,optSpd:[0,14]},
  {name:'LIGHT',ratio:.70,sMin:.18,sMax:.78,bpm:185,top:22,eCost:.005,optSpd:[10,21]},
  {name:'CRUISE',ratio:.85,sMin:.20,sMax:.76,bpm:170,top:30,eCost:.007,optSpd:[18,29]},
  {name:'TEMPO',ratio:1.00,sMin:.22,sMax:.74,bpm:155,top:38,eCost:.010,optSpd:[26,37]},
  {name:'STEADY',ratio:1.15,sMin:.24,sMax:.72,bpm:140,top:46,eCost:.013,optSpd:[34,45]},
  {name:'DRIVE',ratio:1.30,sMin:.26,sMax:.70,bpm:125,top:55,eCost:.017,optSpd:[42,54]},
  {name:'PUSH',ratio:1.48,sMin:.26,sMax:.68,bpm:115,top:64,eCost:.022,optSpd:[50,63]},
  {name:'POWER',ratio:1.66,sMin:.26,sMax:.66,bpm:108,top:74,eCost:.028,optSpd:[59,73]},
  {name:'TURBO',ratio:1.85,sMin:.25,sMax:.65,bpm:100,top:84,eCost:.035,optSpd:[68,83]},
  {name:'OVERDRIVE',ratio:2.05,sMin:.25,sMax:.64,bpm:95,top:95,eCost:.042,optSpd:[78,94]},
  {name:'HYPER',ratio:2.28,sMin:.24,sMax:.62,bpm:90,top:107,eCost:.052,optSpd:[88,106]},
  {name:'WARP',ratio:2.52,sMin:.24,sMax:.62,bpm:85,top:120,eCost:.065,optSpd:[98,120]},
];
const ZONES=[
  {dist:0,name:'CITY STREETS',col:0x4db8ff,fog:0x0a0e1e,gnd:0x10101c,road:0x30304a,line:0x505070},
  {dist:500,name:'COASTAL ROAD',col:0x4dffb8,fog:0x081812,gnd:0x0c1c14,road:0x243830,line:0x4a7a60},
  {dist:1200,name:'FOREST TRAIL',col:0x88cc44,fog:0x0c180a,gnd:0x121c0c,road:0x2a3820,line:0x608a40},
  {dist:2200,name:'MOUNTAIN PASS',col:0xffb84d,fog:0x181208,gnd:0x1c180c,road:0x3a3420,line:0x9a8a50},
  {dist:3500,name:'DESERT FURY',col:0xff6b3d,fog:0x180e08,gnd:0x1c120c,road:0x3a2a1a,line:0x9a6a40},
  {dist:5000,name:'NEON CANYON',col:0xff4d8b,fog:0x180a12,gnd:0x1c0c14,road:0x3a1a2a,line:0x9a4060},
  {dist:7000,name:'THE VOID',col:0xaa44ff,fog:0x100a18,gnd:0x140c1c,road:0x2a1a38,line:0x7a4090},
];

// â”€â”€ ROAD SPLINE â”€â”€
const CURVE_TABLE_SIZE=2048,CURVE_TABLE=new Float32Array(CURVE_TABLE_SIZE),CURVE_PERIOD=ROAD_DRAW_DIST*2.5;
(function(){for(let i=0;i<CURVE_TABLE_SIZE;i++){const t=i/CURVE_TABLE_SIZE;CURVE_TABLE[i]=Math.sin(t*Math.PI*2*1.0)*1.4+Math.sin(t*Math.PI*2*2.7+0.8)*0.6+Math.sin(t*Math.PI*2*0.3+2.1)*2.0}})();
const CURVE_ORIGIN=CURVE_TABLE[0];
function getCurveX(wz){const t=((wz%CURVE_PERIOD)+CURVE_PERIOD)%CURVE_PERIOD;const idx=(t/CURVE_PERIOD)*CURVE_TABLE_SIZE;const i0=Math.floor(idx)%CURVE_TABLE_SIZE;const i1=(i0+1)%CURVE_TABLE_SIZE;const f=idx-Math.floor(idx);const raw=(CURVE_TABLE[i0]*(1-f)+CURVE_TABLE[i1]*f)-CURVE_ORIGIN;const ramp=Math.min(1,S.distance/150);return raw*ramp}
function getCurveDeriv(wz){const e=0.5;return(getCurveX(wz+e)-getCurveX(wz-e))/(2*e)}

// â”€â”€ HEIGHT SPLINE â”€â”€
const HEIGHT_TABLE=new Float32Array(CURVE_TABLE_SIZE),HEIGHT_PERIOD=ROAD_DRAW_DIST*2.5;
(function(){for(let i=0;i<CURVE_TABLE_SIZE;i++){const t=i/CURVE_TABLE_SIZE;
  HEIGHT_TABLE[i]=Math.sin(t*Math.PI*2*1)*3.5  
    +Math.sin(t*Math.PI*2*3+0.7)*1.5            
    +Math.sin(t*Math.PI*2*7+2.1)*0.5;           
}})();
const HEIGHT_ORIGIN=HEIGHT_TABLE[0];
function getHeightY(wz){
  const t=((wz%HEIGHT_PERIOD)+HEIGHT_PERIOD)%HEIGHT_PERIOD;
  const idx=(t/HEIGHT_PERIOD)*CURVE_TABLE_SIZE;
  const i0=Math.floor(idx)%CURVE_TABLE_SIZE;const i1=(i0+1)%CURVE_TABLE_SIZE;
  const f=idx-Math.floor(idx);
  const raw=(HEIGHT_TABLE[i0]*(1-f)+HEIGHT_TABLE[i1]*f)-HEIGHT_ORIGIN;
  const ramp=Math.min(1,S.distance/200);
  const amp=Math.min(4.0,0.5+S.difficulty*0.6);
  return raw*ramp*amp;
}
function getHeightDeriv(wz){const e=0.5;return(getHeightY(wz+e)-getHeightY(wz-e))/(2*e)}
function getSlopeAngle(wz){return Math.atan(getHeightDeriv(wz))}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={score:0,distance:0,speed:0,maxSpeed:0,gear:1,maxGear:12,topGearUsed:1,rpm:0,combo:0,bestCombo:0,energy:1,alive:true,started:false,lastPedal:0,pedalInterval:0,pedalCount:0,difficulty:1,zone:0,shake:0,frame:0,incline:0,lane:1,laneX:0,activePowerup:null,powerupTimer:0,invulnerable:0,_renderIncline:0,_camIncline:0,_worldZ:0,_fovKick:0,_cliffTension:0,_cliffTarget:0,_terrainFeel:0,stats:{perfects:0,cliffs:0,powerups:0}};
let HS=parseInt(localStorage.getItem('gg_hs3')||'0');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THREE.JS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scene=new THREE.Scene();scene.fog=new THREE.FogExp2(0x0a0e1e,.0018);
const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,900);camera.position.set(0,3.5,8);
const renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:"high-performance",stencil:false});
renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.3;renderer.setClearColor(0x0a0e1e);
document.body.prepend(renderer.domElement);
const ambientL=new THREE.AmbientLight(0x556688,1.0);scene.add(ambientL);
const sun=new THREE.DirectionalLight(0xfff0dd,1.6);sun.position.set(8,18,5);sun.castShadow=true;
sun.shadow.mapSize.set(1024,1024);sun.shadow.camera.near=.5;sun.shadow.camera.far=70;
sun.shadow.camera.left=-22;sun.shadow.camera.right=22;sun.shadow.camera.top=22;sun.shadow.camera.bottom=-22;
scene.add(sun);scene.add(new THREE.DirectionalLight(0x88aaff,.4).translateX(-6).translateY(8));
const pLight=new THREE.PointLight(0xff6b3d,.5,35);pLight.position.set(0,3,0);scene.add(pLight);
scene.add(new THREE.HemisphereLight(0x5577aa,0x223344,.5));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROAD GEOMETRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const roadSegs=[],roadGrp=new THREE.Group();scene.add(roadGrp);
const roadMat=new THREE.MeshStandardMaterial({color:0x30304a,roughness:.82,metalness:.05});
const shoulderMat=new THREE.MeshStandardMaterial({color:0x1a1a2a,roughness:.9});
const curbMat=new THREE.MeshStandardMaterial({color:0x444460,roughness:.7,metalness:.1});
const gndMat=new THREE.MeshStandardMaterial({color:0x12121e,roughness:1});
const edgeLineMat=new THREE.MeshBasicMaterial({color:0xdddddd});
const centerLineMat=new THREE.MeshBasicMaterial({color:0xffcc44});
const laneLineMat=new THREE.MeshBasicMaterial({color:0xffffff,transparent:true,opacity:.35});
const rumbleMat=new THREE.MeshStandardMaterial({color:0x882222,roughness:.8});
const guardMat=new THREE.MeshStandardMaterial({color:0x888899,metalness:.6,roughness:.3});
const postMat=new THREE.MeshStandardMaterial({color:0x666677,metalness:.5,roughness:.4});
const matRefRed=new THREE.MeshBasicMaterial({color:0xff4444});
const matRefGrn=new THREE.MeshBasicMaterial({color:0x44ff44});
const matWhite =new THREE.MeshStandardMaterial({color:0xdddddd,roughness:.8});
const GEO={
  roadPlane:new THREE.PlaneGeometry(RW,SEG_LEN),
  shoulder:new THREE.PlaneGeometry(SHOULDER_W,SEG_LEN),curb:new THREE.BoxGeometry(.15,CURB_H,SEG_LEN),
  edgeLine:new THREE.PlaneGeometry(.14,SEG_LEN),centerDash:new THREE.PlaneGeometry(.10,SEG_LEN*.6),
  laneDash:new THREE.PlaneGeometry(.08,SEG_LEN*.4),rumbleBump:new THREE.BoxGeometry(.3,.03,.25),
  guardPost:new THREE.CylinderGeometry(.04,.04,.6,6),guardRail:new THREE.BoxGeometry(.04,.12,RSL*1.5),
  reflector:new THREE.BoxGeometry(.06,.06,.02),marker:new THREE.BoxGeometry(.08,.5,.08),markerBand:new THREE.BoxGeometry(.09,.08,.09),
};

const ROAD_SURFACE_W = 200; 
const seamRoadMat = roadMat.clone();
const seamRoad = new THREE.Mesh(new THREE.PlaneGeometry(ROAD_SURFACE_W, ROAD_DRAW_DIST * 1.5), seamRoadMat);
seamRoad.rotation.x = -Math.PI / 2; seamRoad.position.y = 0.005; seamRoad.receiveShadow = true;
scene.add(seamRoad);

function mkRoadSeg(z,idx){
  const grp=new THREE.Group();grp.position.set(0,0,z);
  [-1,1].forEach(s=>{const c=new THREE.Mesh(GEO.curb,curbMat);c.position.set(s*(RW/2+SHOULDER_W+.075),CURB_H/2,0);c.castShadow=true;c.receiveShadow=true;grp.add(c)});
  [-1,1].forEach(s=>{const e=new THREE.Mesh(GEO.edgeLine,edgeLineMat);e.rotation.x=-Math.PI/2;e.position.set(s*(RW/2-.07),0.015,0);grp.add(e)});
  if(idx%2===0){const c=new THREE.Mesh(GEO.centerDash,centerLineMat);c.rotation.x=-Math.PI/2;c.position.set(0,0.018,0);grp.add(c)}
  [-LANE_W,LANE_W].forEach(x=>{if(idx%2===0){const l=new THREE.Mesh(GEO.laneDash,laneLineMat);l.rotation.x=-Math.PI/2;l.position.set(x,0.014,0);grp.add(l)}});
  if(idx%3===0)[-1,1].forEach(s=>{for(let r=0;r<3;r++){const b=new THREE.Mesh(GEO.rumbleBump,rumbleMat);b.position.set(s*(RW/2+.4),.02,(r-1)*RSL*.3);grp.add(b)}});
  if(idx%8===0&&idx>0)[-1,1].forEach(s=>{const p=new THREE.Mesh(GEO.guardPost,postMat);p.position.set(s*(RW/2+SHOULDER_W+.5),.3,0);p.castShadow=true;grp.add(p);const rl=new THREE.Mesh(GEO.guardRail,guardMat);rl.position.set(s*(RW/2+SHOULDER_W+.5),.45,0);rl.castShadow=true;grp.add(rl);const rf=new THREE.Mesh(GEO.reflector,matRefRed);rf.position.set(s*(RW/2+SHOULDER_W+.5),.45,s>.01?-.01:.01);grp.add(rf)});
  if(idx%16===0&&idx>0){const mk=new THREE.Mesh(GEO.marker,matWhite);mk.position.set(RW/2+SHOULDER_W+.8,.25,0);mk.castShadow=true;grp.add(mk);const bd=new THREE.Mesh(GEO.markerBand,matRefGrn);bd.position.set(RW/2+SHOULDER_W+.8,.42,0);grp.add(bd)}
  grp.userData={idx};roadGrp.add(grp);return grp;
}
for(let i=0;i<RCOUNT;i++)roadSegs.push(mkRoadSeg(-i*RSL,i));
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(1200,1800),gndMat);gnd.rotation.x=-Math.PI/2;gnd.position.set(0,-.01,0);gnd.receiveShadow=true;scene.add(gnd);
const gridMat=new THREE.MeshBasicMaterial({color:0x1a1a28,transparent:true,opacity:.3});
for(let i=-10;i<=10;i++){const g=new THREE.Mesh(new THREE.PlaneGeometry(.03,1800),gridMat);g.rotation.x=-Math.PI/2;g.position.set(i*12,-.06,0);scene.add(g)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BICYCLE MODEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const bikeGrp=new THREE.Group();scene.add(bikeGrp);
const mF=new THREE.MeshStandardMaterial({color:0xdd2222,metalness:.65,roughness:.2}),mF2=new THREE.MeshStandardMaterial({color:0xbb1111,metalness:.65,roughness:.2}),mCr=new THREE.MeshStandardMaterial({color:0xdddddd,metalness:.9,roughness:.1}),mDk=new THREE.MeshStandardMaterial({color:0x222222,roughness:.8}),mTr=new THREE.MeshStandardMaterial({color:0x111111,roughness:.85}),mRm=new THREE.MeshStandardMaterial({color:0xbbbbbb,metalness:.8,roughness:.15}),mSp=new THREE.MeshBasicMaterial({color:0x999999}),mGd=new THREE.MeshStandardMaterial({color:0xccaa33,metalness:.7,roughness:.3});
function mkT(a,b,r=.025,mat=mF){const d=new THREE.Vector3().subVectors(b,a),len=d.length();const m=new THREE.Mesh(new THREE.CylinderGeometry(r,r,len,12),mat);m.position.copy(a).add(d.clone().multiplyScalar(.5));m.quaternion.setFromUnitVectors(new THREE.Vector3(0,1,0),d.clone().normalize());m.castShadow=true;return m}
function mkWheel(zP){const wg=new THREE.Group();wg.add(mp(new THREE.Mesh(new THREE.TorusGeometry(.34,.055,14,40),mTr),{castShadow:true}).translateY(0));wg.children[0].rotation.y=Math.PI/2;const rim=new THREE.Mesh(new THREE.TorusGeometry(.295,.018,10,40),mRm);rim.rotation.y=Math.PI/2;wg.add(rim);const hub=new THREE.Mesh(new THREE.CylinderGeometry(.045,.045,.1,12),mCr);hub.rotation.z=Math.PI/2;wg.add(hub);for(let i=0;i<24;i++){const a=(i/24)*Math.PI*2,mid=.165;const sp=new THREE.Mesh(new THREE.CylinderGeometry(.002,.002,.23,3),mSp);sp.position.set(0,Math.cos(a)*mid,Math.sin(a)*mid);sp.rotation.x=a;wg.add(sp)}wg.position.set(0,.34,zP);return wg}
const frontW=mkWheel(-1),rearW=mkWheel(1);bikeGrp.add(frontW,rearW);
const P={ht:new THREE.Vector3(0,1.06,-.70),hb:new THREE.Vector3(0,.65,-.82),seat:new THREE.Vector3(0,1.12,.30),bb:new THREE.Vector3(0,.42,.12),rear:new THREE.Vector3(0,.34,1),fork:new THREE.Vector3(0,.34,-1),sTop:new THREE.Vector3(0,1.22,.32)};
bikeGrp.add(mkT(P.seat,P.ht,.022),mkT(P.ht,P.bb,.025),mkT(P.seat,P.bb,.028),mkT(P.seat,P.sTop,.014,mCr),mkT(P.ht,P.hb,.02));
[.055,-.055].forEach(x=>{bikeGrp.add(mkT(P.seat.clone().add(new THREE.Vector3(x,-.12,0)),P.rear.clone().add(new THREE.Vector3(x,0,0)),.012,mF2));bikeGrp.add(mkT(P.bb.clone().add(new THREE.Vector3(x,-.04,0)),P.rear.clone().add(new THREE.Vector3(x,0,0)),.014,mF2))});
[.05,-.05].forEach(x=>{bikeGrp.add(mkT(P.hb.clone().add(new THREE.Vector3(x,.05,0)),P.fork.clone().add(new THREE.Vector3(x,0,0)),.016,mCr))});
const hbar=new THREE.Mesh(new THREE.TorusGeometry(.15,.008,8,20,Math.PI),mCr);hbar.position.set(0,1.12,-.80);hbar.rotation.x=Math.PI/2;hbar.rotation.z=Math.PI;bikeGrp.add(hbar);
[-.15,.15].forEach(x=>{const g=new THREE.Mesh(new THREE.CylinderGeometry(.014,.014,.08,10),mDk);g.position.set(x,1.12,-.95);g.rotation.z=Math.PI/2;bikeGrp.add(g)});
bikeGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.12,.03,.26),mDk).translateY(1.235).translateZ(.30));
const chainring=new THREE.Mesh(new THREE.TorusGeometry(.10,.012,8,30),mGd);chainring.position.copy(P.bb);chainring.rotation.y=Math.PI/2;bikeGrp.add(chainring);
const crankGrp=new THREE.Group();crankGrp.position.copy(P.bb);const cAG=new THREE.BoxGeometry(.02,.17,.012);crankGrp.add(new THREE.Mesh(cAG,mCr).translateX(.06).translateY(.085));crankGrp.add(new THREE.Mesh(cAG,mCr).translateX(-.06).translateY(-.085));const pG=new THREE.BoxGeometry(.09,.015,.05);crankGrp.add(new THREE.Mesh(pG,mDk).translateX(.06).translateY(.17));crankGrp.add(new THREE.Mesh(pG,mDk).translateX(-.06).translateY(-.17));bikeGrp.add(crankGrp);
const sprocket=new THREE.Mesh(new THREE.TorusGeometry(.05,.008,6,20),mCr);sprocket.position.copy(P.rear);sprocket.rotation.y=Math.PI/2;bikeGrp.add(sprocket);
const mChn=new THREE.MeshStandardMaterial({color:0x444444,metalness:.6,roughness:.5});
bikeGrp.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3([P.bb.clone().add(new THREE.Vector3(0,-.07,0)),P.rear.clone().add(new THREE.Vector3(0,-.03,0))]),10,.006,6,false),mChn));
bikeGrp.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3([P.rear.clone().add(new THREE.Vector3(0,.03,0)),P.bb.clone().add(new THREE.Vector3(0,.07,0))]),10,.006,6,false),mChn));
bikeGrp.add(new THREE.Mesh(new THREE.CylinderGeometry(.032,.035,.20,10),new THREE.MeshStandardMaterial({color:0x2288ff,roughness:.5})).translateY(.72).translateZ(-.18));
const headL=new THREE.SpotLight(0xffffee,2.5,40,.5,.6,1.2);headL.position.set(0,.9,-.85);headL.target.position.set(0,0,-12);bikeGrp.add(headL,headL.target);
bikeGrp.add(new THREE.Mesh(new THREE.SphereGeometry(.03,8,8),new THREE.MeshBasicMaterial({color:0xffffcc})).translateY(.9).translateZ(-.88));
bikeGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.04,.03,.015),new THREE.MeshBasicMaterial({color:0xff2200})).translateY(1.15).translateZ(.42));
bikeGrp.add(new THREE.PointLight(0xff2200,.4,4).translateY(1.1).translateZ(.45));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RIDER MODEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const riderGrp=new THREE.Group();bikeGrp.add(riderGrp);
const mJ=new THREE.MeshStandardMaterial({color:0x1144cc,roughness:.65,metalness:.05}),mJ2=new THREE.MeshStandardMaterial({color:0x0033aa,roughness:.65,metalness:.05}),mSh=new THREE.MeshStandardMaterial({color:0x0a0a22,roughness:.75}),mSk=new THREE.MeshStandardMaterial({color:0xe8b88a,roughness:.85}),mHe=new THREE.MeshStandardMaterial({color:0xee2222,metalness:.35,roughness:.35}),mHe2=new THREE.MeshStandardMaterial({color:0xcc1111,metalness:.35,roughness:.35}),mSo=new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.75,metalness:.1}),mGl=new THREE.MeshStandardMaterial({color:0x050505,metalness:.95,roughness:.05}),mGv=new THREE.MeshStandardMaterial({color:0x111111,roughness:.65,metalness:.1}),mSc=new THREE.MeshStandardMaterial({color:0xf0f0f0,roughness:.85});
const hipGrp=new THREE.Group();hipGrp.position.set(0,1.18,.30);riderGrp.add(hipGrp);
const pelvis=new THREE.Mesh(new THREE.SphereGeometry(.10,12,10),mSh);pelvis.scale.set(1.2,.7,1);pelvis.castShadow=true;hipGrp.add(pelvis);
const spineGrp=new THREE.Group();spineGrp.position.set(0,.06,0);hipGrp.add(spineGrp);
spineGrp.add(mp(new THREE.Mesh(new THREE.CylinderGeometry(.09,.11,.16,12),mJ),{position:new THREE.Vector3(0,.08,0),castShadow:true}));
spineGrp.add(mp(new THREE.Mesh(new THREE.CylinderGeometry(.12,.10,.28,14),mJ),{position:new THREE.Vector3(0,.30,0),castShadow:true}));
spineGrp.add(new THREE.Mesh(new THREE.CylinderGeometry(.125,.105,.04,14),new THREE.MeshStandardMaterial({color:0xffffff,roughness:.7})).translateY(.34));
spineGrp.add(new THREE.Mesh(new THREE.CylinderGeometry(.123,.103,.025,14),new THREE.MeshStandardMaterial({color:0xff3333,roughness:.7})).translateY(.37));
for(let i=-1;i<=1;i++)spineGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.06,.04,.03),mJ2).translateX(i*.05).translateY(.17).translateZ(-.10));
const shY=.44,shX=.13;[-1,1].forEach(s=>{const sh=new THREE.Mesh(new THREE.SphereGeometry(.05,10,10),mJ);sh.scale.set(1.1,.8,1);sh.position.set(s*shX,shY,0);sh.castShadow=true;spineGrp.add(sh)});
const neckGrp=new THREE.Group();neckGrp.position.set(0,.48,.02);spineGrp.add(neckGrp);neckGrp.add(new THREE.Mesh(new THREE.CylinderGeometry(.028,.032,.06,8),mSk));
const headGrp=new THREE.Group();headGrp.position.set(0,.06,0);neckGrp.add(headGrp);
const sk=new THREE.Mesh(new THREE.SphereGeometry(.082,16,14),mSk);sk.scale.set(.95,1.05,.90);sk.castShadow=true;headGrp.add(sk);
const ch=new THREE.Mesh(new THREE.SphereGeometry(.03,8,8),mSk);ch.position.set(0,-.06,.05);ch.scale.set(1,.6,1);headGrp.add(ch);
headGrp.add(mp(new THREE.Mesh(new THREE.SphereGeometry(.098,16,14,0,Math.PI*2,0,Math.PI*.62),mHe),{position:new THREE.Vector3(0,.01,0),castShadow:true}));
for(let i=-1;i<=1;i++)headGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.012,.004,.07),mDk).translateX(i*.03).translateY(.085).translateZ(-.015));
const ht=new THREE.Mesh(new THREE.CylinderGeometry(.02,.006,.14,6),mHe2);ht.rotation.x=.7;ht.position.set(0,.04,-.11);headGrp.add(ht);
const glGrp=new THREE.Group();glGrp.position.set(0,-.01,.075);headGrp.add(glGrp);
glGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.05,.024,.012),mGl).translateX(.028));glGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.05,.024,.012),mGl).translateX(-.028));glGrp.add(new THREE.Mesh(new THREE.BoxGeometry(.015,.01,.012),mGl));
function mkArm(side){const sp=new THREE.Group();sp.position.set(side*shX,shY,0);const sg=new THREE.Group();const u=new THREE.Mesh(new THREE.CylinderGeometry(.038,.032,.22,10),mJ);u.position.y=-.11;u.castShadow=true;sg.add(u);sg.add(new THREE.Mesh(new THREE.CylinderGeometry(.034,.036,.02,10),mJ2).translateY(-.21));sp.add(sg);const ep=new THREE.Group();ep.position.set(0,-.22,0);ep.add(new THREE.Mesh(new THREE.SphereGeometry(.024,8,8),mSk));const fa=new THREE.Mesh(new THREE.CylinderGeometry(.028,.020,.20,10),mSk);fa.position.y=-.10;fa.castShadow=true;ep.add(fa);const wp=new THREE.Group();wp.position.set(0,-.20,0);wp.add(new THREE.Mesh(new THREE.BoxGeometry(.035,.025,.045),mGv).translateY(-.01).translateZ(.005));wp.add(mp(new THREE.Mesh(new THREE.CylinderGeometry(.018,.018,.04,6),mGv),{rotation:{x:0,y:0,z:Math.PI/2}}).translateY(-.025).translateZ(.005));ep.add(wp);sp.add(ep);sp.userData={elbow:ep,wrist:wp,side};return sp}
const lArm=mkArm(1),rArm=mkArm(-1);spineGrp.add(lArm,rArm);
function mkLeg(side){const hp=new THREE.Group();hp.position.set(side*.07,-.04,.01);hp.add(mp(new THREE.Mesh(new THREE.CylinderGeometry(.060,.048,.30,12),mSh),{position:new THREE.Vector3(0,-.15,0),castShadow:true}));hp.add(new THREE.Mesh(new THREE.CylinderGeometry(.049,.051,.015,12),new THREE.MeshStandardMaterial({color:0x222244,roughness:.6})).translateY(-.29));const kp=new THREE.Group();kp.position.set(0,-.30,0);kp.add(new THREE.Mesh(new THREE.SphereGeometry(.032,8,8),mSk).translateZ(.01));kp.add(mp(new THREE.Mesh(new THREE.CylinderGeometry(.038,.030,.26,12),mSk),{position:new THREE.Vector3(0,-.13,0),castShadow:true}));const cf=new THREE.Mesh(new THREE.SphereGeometry(.032,8,8),mSk);cf.scale.set(.8,1.5,.8);cf.position.set(0,-.078,-.02);kp.add(cf);kp.add(new THREE.Mesh(new THREE.CylinderGeometry(.032,.030,.10,10),mSc).translateY(-.23));const sg=new THREE.Group();sg.position.set(0,-.27,0);sg.add(new THREE.Mesh(new THREE.BoxGeometry(.05,.028,.12),mSo).translateY(-.012).translateZ(.015));sg.add(new THREE.Mesh(new THREE.BoxGeometry(.052,.007,.12),new THREE.MeshStandardMaterial({color:0xcc1111,roughness:.5,metalness:.2})).translateY(-.03).translateZ(.015));sg.add(new THREE.Mesh(new THREE.BoxGeometry(.025,.005,.035),mDk).translateY(-.035).translateZ(.005));sg.add(new THREE.Mesh(new THREE.BoxGeometry(.03,.02,.015),new THREE.MeshStandardMaterial({color:0xff3333,roughness:.6})).translateZ(-.04));kp.add(sg);hp.add(kp);hp.userData={knee:kp,side};return hp}
const lLeg=mkLeg(1),rLeg=mkLeg(-1);hipGrp.add(lLeg,rLeg);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OBSTACLES & POWERUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const obstacles=[],powerupObjs=[];
function mkCliff(){
  const g=new THREE.Group();
  const w=RW+8, gap=2.5+Math.random()*2;
  const wallH=4, wallD=0.6;
  const nw=gm(GA.box,matCliffWall,w,wallH,wallD);nw.position.set(0,-wallH/2+.05,gap/2);nw.receiveShadow=true;g.add(nw);
  const fw=gm(GA.box,matCliffWall,w,wallH,wallD);fw.position.set(0,-wallH/2+.05,-gap/2);fw.receiveShadow=true;g.add(fw);
  const ab=gm(GA.plane,matAbyss,w,gap+.5,1);ab.rotation.x=-Math.PI/2;ab.position.set(0,-wallH,0);g.add(ab);
  [-1,1].forEach(s=>{const e=gm(GA.box,matCliffDirt,w,.15,.4);e.position.set(0,.06,s*(gap/2+.5));g.add(e)});
  // Ramp
  const ramp=gm(GA.box,matCliffRamp,RW*.7,.25,2.5);ramp.position.set(0,.12,gap/2+2);ramp.rotation.x=.08;ramp.castShadow=true;g.add(ramp);
  for(let i=0;i<5;i++){const st=gm(GA.box,i%2===0?matChevY:matChevB,RW*.6,.01,.12);st.position.set(0,.26,gap/2+1.2+i*.35);st.rotation.x=.08;g.add(st)}
  // Barriers
  [-1,1].forEach(s=>{
    const bd=gm(GA.box,matCliffBar,.15,1.4,.8);bd.position.set(s*(RW/2+.5),.7,gap/2+1);bd.castShadow=true;g.add(bd);
    const ws=gm(GA.box,matConeWhite,.16,.18,.7);ws.position.set(s*(RW/2+.5),.9,gap/2+1);g.add(ws);
  });
  // Warning cones
  for(let i=0;i<6;i++){
    [-1,1].forEach(s=>{
      const cn=gm(GA.cone,matOrange,.12,.45,.12);cn.position.set(s*(RW/2-.3),.22,gap/2+5+i*2.5);g.add(cn);
      const band=gm(GA.cyl,matConeWhite,.11,.06,.12);band.position.set(s*(RW/2-.3),.32,gap/2+5+i*2.5);g.add(band);
    });
  }
  // Road chevrons
  for(let i=0;i<4;i++){const ch=gm(GA.plane,matChevRoad,RW*.4,.15,1);ch.rotation.x=-Math.PI/2;ch.position.set(0,.02,gap/2+4+i*2);g.add(ch)}
  // Reflectors
  [-1,1].forEach(s=>{
    const r1=gm(GA.sphLo,matRefRed,.08,.08,.08);r1.position.set(s*(RW/2+.3),.5,gap/2+.3);g.add(r1);
    const r2=gm(GA.sphLo,matRefGrn,.08,.08,.08);r2.position.set(s*(RW/2+.3),.5,-gap/2-.3);g.add(r2);
  });
  g.userData={type:'cliff',gap:gap,reqSpeed:20+S.difficulty*5,cleared:false};
  return g;
}
const puMats={};POWERUPS.forEach(p=>{puMats[p.type]=new THREE.MeshStandardMaterial({color:p.color,emissive:p.color,emissiveIntensity:.5})});
const puRingMat={};POWERUPS.forEach(p=>{puRingMat[p.type]=new THREE.MeshBasicMaterial({color:p.color,transparent:true,opacity:.6})});
function mkPU(type){const def=POWERUPS.find(p=>p.type===type);const g=new THREE.Group();
  const core=gm(GA.sphHi,puMats[type],.25,.25,.25);g.add(core);
  const r1=gm(GA.torus,puRingMat[type],.4,.4,.4);g.add(r1);
  const r2=gm(GA.torus,puRingMat[type],.4,.4,.4);r2.rotation.x=Math.PI/2;g.add(r2);
  g.add(new THREE.PointLight(def.color,.8,10));
  g.userData={type:'powerup',pType:type,def,rot:Math.random()*6,bob:Math.random()*6};return g;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCENERY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sceneryGrp=new THREE.Group();scene.add(sceneryGrp);
const sceneryItems=[];
const SCENERY_COUNT=160;
const SCENERY_SPACING=6;
const ROAD_EDGE=RW/2+SHOULDER_W+.3;

const matBark  =new THREE.MeshStandardMaterial({color:0x4a3018,roughness:.9});
const matLeaf  =new THREE.MeshStandardMaterial({color:0x1a4422,roughness:.9});
const matLeaf2 =new THREE.MeshStandardMaterial({color:0x2a5522,roughness:.9});
const matConc  =new THREE.MeshStandardMaterial({color:0x555566,roughness:.85,metalness:.05});
const matConc2 =new THREE.MeshStandardMaterial({color:0x444455,roughness:.85,metalness:.05});
const matMetal =new THREE.MeshStandardMaterial({color:0x777788,metalness:.6,roughness:.3});
const matGlass =new THREE.MeshStandardMaterial({color:0x88bbff,metalness:.3,roughness:.1,transparent:true,opacity:.6});
const matRoof  =new THREE.MeshStandardMaterial({color:0x663322,roughness:.8});
const matBrick =new THREE.MeshStandardMaterial({color:0x884433,roughness:.85});
const matBrick2=new THREE.MeshStandardMaterial({color:0x775544,roughness:.85});
const matYellow=new THREE.MeshStandardMaterial({color:0xccaa22,roughness:.7});
const matRed   =new THREE.MeshStandardMaterial({color:0xcc2222,roughness:.7});
const matBlue  =new THREE.MeshStandardMaterial({color:0x2244cc,roughness:.7});
const matBlack =new THREE.MeshStandardMaterial({color:0x111111,roughness:.9});
const matTire  =new THREE.MeshStandardMaterial({color:0x222222,roughness:.85});
const matPole  =new THREE.MeshStandardMaterial({color:0x666666,metalness:.5,roughness:.4});
const matBanner=new THREE.MeshStandardMaterial({color:0xff4444,roughness:.7,side:THREE.DoubleSide});
const matBanner2=new THREE.MeshStandardMaterial({color:0x4488ff,roughness:.7,side:THREE.DoubleSide});
const matSkin  =new THREE.MeshStandardMaterial({color:0xe8b88a,roughness:.85});
const matShirt1=new THREE.MeshStandardMaterial({color:0xcc3333,roughness:.75});
const matShirt2=new THREE.MeshStandardMaterial({color:0x3366cc,roughness:.75});
const matShirt3=new THREE.MeshStandardMaterial({color:0x33aa33,roughness:.75});
const matShirt4=new THREE.MeshStandardMaterial({color:0xffaa00,roughness:.75});
const matPants =new THREE.MeshStandardMaterial({color:0x333344,roughness:.8});
const matHair1 =new THREE.MeshStandardMaterial({color:0x332211,roughness:.9});
const matHair2 =new THREE.MeshStandardMaterial({color:0x885522,roughness:.9});
const matHair3 =new THREE.MeshStandardMaterial({color:0xddbb66,roughness:.9});
const shirtMats=[matShirt1,matShirt2,matShirt3,matShirt4];
const hairMats =[matHair1,matHair2,matHair3];

const GA={
  box:    new THREE.BoxGeometry(1,1,1),
  cyl:    new THREE.CylinderGeometry(1,1,1,8),
  cylHi:  new THREE.CylinderGeometry(1,1,1,12),
  cylLo:  new THREE.CylinderGeometry(1,1,1,6),
  sphere: new THREE.SphereGeometry(1,10,10),
  sphLo:  new THREE.SphereGeometry(1,6,4),
  sphHi:  new THREE.SphereGeometry(1,14,14),
  cone:   new THREE.ConeGeometry(1,1,6),
  coneLo: new THREE.ConeGeometry(1,1,8),
  plane:  new THREE.PlaneGeometry(1,1),
  dodec:  new THREE.DodecahedronGeometry(1,1),
  torus:  new THREE.TorusGeometry(1,.08,8,28),
};

const matLitWindow=new THREE.MeshBasicMaterial({color:0xffeeaa});
const matHeadlight=new THREE.MeshBasicMaterial({color:0xffffcc});
const matTaillight=new THREE.MeshBasicMaterial({color:0xff2200});
const matLampGlow =new THREE.MeshStandardMaterial({color:0xffee88,emissive:0xffcc44,emissiveIntensity:3});
const matOrange   =new THREE.MeshStandardMaterial({color:0xff6600,roughness:.4});
const matConeWhite=new THREE.MeshBasicMaterial({color:0xffffff});
const matCliffWall=new THREE.MeshStandardMaterial({color:0x2a1a0e,roughness:.9});
const matCliffDirt=new THREE.MeshStandardMaterial({color:0x5a3a1e,roughness:1});
const matCliffRamp=new THREE.MeshStandardMaterial({color:0x997744,roughness:.6});
const matCliffBar =new THREE.MeshStandardMaterial({color:0xff6600,roughness:.5,emissive:0x331100});
const matAbyss    =new THREE.MeshBasicMaterial({color:0x020202});
const matChevY    =new THREE.MeshBasicMaterial({color:0xffaa00});
const matChevB    =new THREE.MeshBasicMaterial({color:0x222222});
const matChevRoad =new THREE.MeshBasicMaterial({color:0xffaa00,transparent:true,opacity:0.7});
function gm(geo,mat,sx,sy,sz){const m=new THREE.Mesh(geo,mat);m.scale.set(sx,sy,sz);return m}

function mkTree(){
  const g=new THREE.Group();
  const h=1.2+Math.random()*.8;
  const trunk=gm(GA.cylLo,matBark,.08,h,.08);
  trunk.position.y=h/2;trunk.castShadow=true;g.add(trunk);
  const fs=.5+Math.random()*.4;
  const fol=gm(GA.dodec,Math.random()>.5?matLeaf:matLeaf2,fs,fs*(1.2+Math.random()*.4),fs);
  fol.position.y=h+.3+Math.random()*.3;fol.castShadow=true;g.add(fol);
  return g;
}
function mkPineTree(){
  const g=new THREE.Group();const h=2+Math.random();
  const trunk=gm(GA.cylLo,matBark,.06,h,.06);trunk.position.y=h/2;trunk.castShadow=true;g.add(trunk);
  for(let i=0;i<3;i++){const s=.6-.15*i;const cn=gm(GA.coneLo,matLeaf,s,.7,s);cn.position.y=h*.5+i*.55;cn.castShadow=true;g.add(cn)}
  return g;
}
function mkLamp(){
  const g=new THREE.Group();
  const pole=gm(GA.cylLo,matPole,.03,4,.03);pole.position.y=2;g.add(pole);
  const arm=gm(GA.box,matMetal,.08,.04,.3);arm.position.set(0,4,-.1);g.add(arm);
  const bulb=gm(GA.sphLo,matLampGlow,.06,.06,.06);bulb.position.set(0,3.95,-.2);g.add(bulb);
  g.add(new THREE.PointLight(0xffcc44,.3,12).translateY(3.9).translateZ(-.2));
  return g;
}
function mkBarrier(){
  const g=new THREE.Group();const w=1.5+Math.random();
  const wall=gm(GA.box,matConc,w,.8,.15);wall.position.y=.4;g.add(wall);
  for(let i=0;i<Math.floor(w/.4);i++){
    const s=gm(GA.box,i%2?matRed:matWhite,.05,.6,.16);s.position.set(-w/2+.2+i*.4,.4,0);g.add(s);
  }
  return g;
}
const carColors=[0xcc2222,0x2255cc,0x22aa44,0xdddddd,0x111111,0xffaa00,0x8822aa];
const carMats=carColors.map(c=>new THREE.MeshStandardMaterial({color:c,metalness:.5,roughness:.3}));
function mkCar(){
  const g=new THREE.Group();
  const bodyMat=carMats[Math.floor(Math.random()*carMats.length)];
  const body=gm(GA.box,bodyMat,1.6,.5,3.2);body.position.y=.45;body.castShadow=true;g.add(body);
  const cab=gm(GA.box,bodyMat,1.3,.45,1.6);cab.position.set(0,.85,-.15);cab.castShadow=true;g.add(cab);
  const win=gm(GA.box,matGlass,1.31,.35,1.5);win.position.set(0,.87,-.15);g.add(win);
  [[-0.7,0.2,-0.9],[0.7,0.2,-0.9],[-0.7,0.2,0.9],[0.7,0.2,0.9]].forEach(([x,y,z])=>{
    const w=gm(GA.cyl,matTire,.18,.12,.18);w.position.set(x,y,z);g.add(w);
  });
  const hl1=gm(GA.box,matHeadlight,.2,.1,.02);hl1.position.set(-.5,.45,-1.61);g.add(hl1);
  const hl2=gm(GA.box,matHeadlight,.2,.1,.02);hl2.position.set(.5,.45,-1.61);g.add(hl2);
  const tl1=gm(GA.box,matTaillight,.15,.08,.02);tl1.position.set(-.55,.45,1.61);g.add(tl1);
  const tl2=gm(GA.box,matTaillight,.15,.08,.02);tl2.position.set(.55,.45,1.61);g.add(tl2);
  g.rotation.y=Math.random()*0.3-0.15;
  return g;
}
const matVanBody=new THREE.MeshStandardMaterial({color:0xeeeeee,roughness:.6,metalness:.1});
function mkVan(){
  const g=new THREE.Group();
  const body=gm(GA.box,matVanBody,1.8,1.4,3.5);body.position.y=.9;body.castShadow=true;g.add(body);
  const win=gm(GA.box,matGlass,1.5,.5,1);win.position.set(0,1.35,-1);g.add(win);
  [[-0.8,0.2,-1.1],[0.8,0.2,-1.1],[-0.8,0.2,1.1],[0.8,0.2,1.1]].forEach(([x,y,z])=>{
    const w=gm(GA.cyl,matTire,.22,.14,.22);w.position.set(x,y,z);g.add(w);
  });
  return g;
}
function mkBuilding(){
  const g=new THREE.Group();
  const w=2+Math.random()*3,h=3+Math.random()*6,d=2+Math.random()*2;
  const bMat=Math.random()>.5?matBrick:matBrick2;
  const body=gm(GA.box,bMat,w,h,d);body.position.y=h/2;body.castShadow=true;body.receiveShadow=true;g.add(body);
  const roof=gm(GA.box,matConc2,w+.2,.15,d+.2);roof.position.y=h+.075;g.add(roof);
  const wRows=Math.floor(h/1.2),wCols=Math.max(1,Math.floor(w/1.2));
  for(let r=0;r<wRows;r++)for(let c=0;c<wCols;c++){
    const wx=-w/2+.6+c*(w-1)/Math.max(1,wCols-1||1);
    const wy=1+r*1.2;
    if(wy<h-.5){
      const wMat=Math.random()>.4?matLitWindow:matGlass;
      const wn=gm(GA.box,wMat,.4,.5,.02);wn.position.set(wCols>1?wx:0,wy,-d/2-.01);g.add(wn);
    }
  }
  const door=gm(GA.box,matConc,.5,.9,.02);door.position.set(0,.45,-d/2-.01);g.add(door);
  return g;
}
function mkSpectator(){
  const g=new THREE.Group();
  const shirt=shirtMats[Math.floor(Math.random()*shirtMats.length)];
  const hair=hairMats[Math.floor(Math.random()*hairMats.length)];
  const ll=gm(GA.cyl,matPants,.04,.5,.04);ll.position.set(-.06,.25,0);g.add(ll);
  const rl=gm(GA.cyl,matPants,.04,.5,.04);rl.position.set(.06,.25,0);g.add(rl);
  const torso=gm(GA.cyl,shirt,.10,.4,.08);torso.position.y=.7;torso.castShadow=true;g.add(torso);
  const head=gm(GA.sphere,matSkin,.08,.084,.072);head.position.y=1.0;head.castShadow=true;g.add(head);
  const hr=gm(GA.sphere,hair,.082,.082,.082);hr.position.y=1.02;g.add(hr);
  const cheering=Math.random()>.4;
  [-1,1].forEach(s=>{
    const arm=gm(GA.cylLo,shirt,.025,.35,.025);
    if(cheering&&s>0){arm.position.set(s*.14,1.05,0);arm.rotation.z=s*(-0.3-Math.random()*.8)}
    else{arm.position.set(s*.14,.7,0);arm.rotation.z=s*.15}
    g.add(arm);
  });
  if(Math.random()>.6){
    const fp=gm(GA.cylLo,matPole,.008,.6,.008);fp.position.set(.14,1.2,0);g.add(fp);
    const fl=gm(GA.plane,Math.random()>.5?matBanner:matBanner2,.25,.15,1);fl.position.set(.14,1.45,.05);g.add(fl);
  }
  return g;
}
function mkSpectatorGroup(){
  const g=new THREE.Group();
  const count=2+Math.floor(Math.random()*5);
  for(let i=0;i<count;i++){
    const s=mkSpectator();
    s.position.set((i-count/2)*.35+Math.random()*.1,0,Math.random()*.3);
    s.rotation.y=Math.random()*.4-.2;g.add(s);
  }
  if(Math.random()>.3){
    const bar=gm(GA.box,matMetal,count*.4,.7,.08);bar.position.set(0,.35,-.25);g.add(bar);
  }
  return g;
}
function mkBannerArch(){
  const g=new THREE.Group();
  const halfW=RW/2+SHOULDER_W+0.5;
  [-1,1].forEach(s=>{
    const p=gm(GA.cyl,matPole,.05,5,.05);p.position.set(s*halfW,2.5,0);g.add(p);
  });
  const bw=halfW*2;
  const bn=gm(GA.box,Math.random()>.5?matBanner:matBanner2,bw,.7,.06);bn.position.y=5.1;g.add(bn);
  const tx=gm(GA.box,matWhite,bw*.8,.18,.07);tx.position.y=5.1;g.add(tx);
  g.userData._centered=true;
  return g;
}
function mkTrashCan(){
  const g=new THREE.Group();
  const body=gm(GA.cyl,matConc,.15,.5,.12);body.position.y=.25;g.add(body);
  const lid=gm(GA.cyl,matMetal,.16,.03,.16);lid.position.y=.51;g.add(lid);
  return g;
}
function mkBench(){
  const g=new THREE.Group();
  const seat=gm(GA.box,matBark,.8,.04,.3);seat.position.y=.4;g.add(seat);
  const back=gm(GA.box,matBark,.8,.3,.04);back.position.set(0,.35,-.13);g.add(back);
  [-.3,.3].forEach(x=>{const lg=gm(GA.box,matMetal,.04,.4,.25);lg.position.set(x,.2,0);g.add(lg)});
  return g;
}
function mkCone(){
  const g=new THREE.Group();
  const cn=gm(GA.cone,matRed,.1,.3,.1);cn.position.y=.15;g.add(cn);
  const base=gm(GA.box,matRed,.2,.02,.2);base.position.y=.01;g.add(base);
  const band=gm(GA.cyl,matConeWhite,.07,.04,.06);band.position.y=.2;g.add(band);
  return g;
}

function spawnSceneryItem(z,idx){
  const side=idx%2===0?-1:1;
  const r=Math.random();
  let mesh,minDist,maxDist;
  if(r<.15){mesh=mkTree();minDist=1;maxDist=12}
  else if(r<.22){mesh=mkPineTree();minDist=1;maxDist=12}
  else if(r<.30){mesh=mkLamp();minDist=.8;maxDist=1.5}
  else if(r<.38){mesh=mkSpectatorGroup();minDist=1;maxDist=3}
  else if(r<.42){mesh=mkSpectator();minDist=1;maxDist=2.5}
  else if(r<.50){mesh=mkCar();minDist=3;maxDist=8}
  else if(r<.54){mesh=mkVan();minDist=3.5;maxDist=8}
  else if(r<.64){mesh=mkBuilding();minDist=6;maxDist=18}
  else if(r<.70){mesh=mkBarrier();minDist=.3;maxDist=1}
  else if(r<.74){mesh=mkBannerArch();minDist=0;maxDist=0}
  else if(r<.80){mesh=mkTrashCan();minDist=.5;maxDist=1.5}
  else if(r<.86){mesh=mkBench();minDist=.5;maxDist=2}
  else if(r<.92){mesh=mkCone();minDist=.2;maxDist=.8}
  else{mesh=mkTree();minDist=1;maxDist=8}

  const sideOffset=mesh.userData._centered?0:(ROAD_EDGE+minDist+Math.random()*(maxDist-minDist));
  mesh.userData._side=mesh.userData._centered?0:side;
  mesh.userData._sideOffset=sideOffset;
  mesh.userData._localZ=z;
  mesh.position.z=z;
  if(r>=.30&&r<.42)mesh.rotation.y=side>0?-Math.PI/2:Math.PI/2;
  sceneryGrp.add(mesh);
  sceneryItems.push(mesh);
}
for(let i=0;i<SCENERY_COUNT;i++){
  spawnSceneryItem(-i*SCENERY_SPACING-Math.random()*2,i);
}

const sGeo=new THREE.BufferGeometry(),sP=[];
for(let i=0;i<2000;i++)sP.push((Math.random()-.5)*300,Math.random()*80+10,(Math.random()-.5)*300);
sGeo.setAttribute('position',new THREE.Float32BufferAttribute(sP,3));
scene.add(new THREE.Points(sGeo,new THREE.PointsMaterial({color:0xffffff,size:.1,transparent:true,opacity:.7})));

const PC=180;const pGeo=new THREE.BufferGeometry();
const pPos=new Float32Array(PC*3),pCol=new Float32Array(PC*3),pVel=[];
for(let i=0;i<PC;i++){pPos[i*3]=0;pPos[i*3+1]=-10;pPos[i*3+2]=0;pCol[i*3]=1;pCol[i*3+1]=.7;pCol[i*3+2]=.3;pVel.push({x:0,y:0,z:0,life:0,kind:0})}
pGeo.setAttribute('position',new THREE.Float32BufferAttribute(pPos,3));pGeo.setAttribute('color',new THREE.Float32BufferAttribute(pCol,3));
const parts=new THREE.Points(pGeo,new THREE.PointsMaterial({size:.06,transparent:true,opacity:.8,vertexColors:true}));scene.add(parts);
function emit(x,y,z,n,col,kind=0){const c=new THREE.Color(col||0xffb84d);for(let i=0;i<PC&&n>0;i++){if(pVel[i].life<=0){pPos[i*3]=x+(Math.random()-.5)*.5;pPos[i*3+1]=y;pPos[i*3+2]=z+(Math.random()-.5)*.5;pCol[i*3]=c.r;pCol[i*3+1]=c.g;pCol[i*3+2]=c.b;if(kind===1)pVel[i]={x:(Math.random()-.5)*.5,y:Math.random()*.3,z:.5+Math.random(),life:.4+Math.random()*.3,kind:1};else pVel[i]={x:(Math.random()-.5)*2.5,y:Math.random()*3.5+1,z:(Math.random()-.5)*2.5,life:.8+Math.random()*.4,kind:0};n--}}pGeo.attributes.position.needsUpdate=true;pGeo.attributes.color.needsUpdate=true}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let actx;function initA(){if(!actx)actx=new(window.AudioContext||window.webkitAudioContext)()}
function tone(f,d,t='square',v=.04){if(!actx)return;const o=actx.createOscillator(),g=actx.createGain();o.type=t;o.frequency.setValueAtTime(f,actx.currentTime);g.gain.setValueAtTime(v,actx.currentTime);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+d);o.connect(g).connect(actx.destination);o.start();o.stop(actx.currentTime+d)}
function sndPedal(){tone(140+S.gear*22,.04,'triangle',.03)}
function sndShift(up){tone(up?420:200,.08,'square',.025);setTimeout(()=>tone(up?620:300,.08,'square',.025),45)}
function sndPerfect(){tone(523,.1,'sine',.05);setTimeout(()=>tone(659,.1,'sine',.05),70);setTimeout(()=>tone(784,.15,'sine',.04),140);setTimeout(()=>tone(1047,.2,'sine',.03),220)}
function sndCrash(){tone(80,.5,'sawtooth',.08);tone(45,.7,'sawtooth',.06)}
function sndPowerup(){if(!actx)return;[523,659,784,1047].forEach((f,i)=>{const o=actx.createOscillator(),g=actx.createGain();o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(.04,actx.currentTime+i*.07);g.gain.exponentialRampToValueAtTime(.001,actx.currentTime+i*.07+.25);o.connect(g).connect(actx.destination);o.start(actx.currentTime+i*.07);o.stop(actx.currentTime+i*.07+.25)})}
function sndCombo(){tone(880,.1,'sine',.03)}
let windOsc,windGain;function updateWind(){if(!actx)return;if(!windOsc){windOsc=actx.createOscillator();windGain=actx.createGain();windOsc.frequency.value=60;windGain.gain.value=0;windOsc.connect(windGain).connect(actx.destination);windOsc.start()}windGain.gain.setTargetAtTime(Math.min(.1,S.speed/800),actx.currentTime,.15);windOsc.frequency.setTargetAtTime(40+S.speed*1.5,actx.currentTime,.15)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $=id=>document.getElementById(id);
function updHUD(){$('h-score').textContent=Math.floor(S.score).toLocaleString();const spd=Math.floor(S.speed);$('h-speed').textContent=spd;$('h-speed').style.color=spd>80?'#ff4d8b':spd>50?'#ffb84d':'#fff';$('h-gear').textContent=S.gear;const[oL2,oH2]=GEARS[S.gear].optSpd;const inOpt2=S.speed>=oL2&&S.speed<=oH2;$('h-gname').textContent=GEARS[S.gear].name+(inOpt2?' âœ“':S.speed>3?' âš ':'');$('h-dist').textContent=Math.floor(S.distance).toLocaleString();$('h-best').textContent=HS.toLocaleString();const gd=GEARS[S.gear],rN=Math.min(1,S.rpm);$('rpm-fill').style.height=(rN*100)+'%';$('rpm-sweet').style.bottom=(gd.sMin*100)+'%';$('rpm-sweet').style.height=((gd.sMax-gd.sMin)*100)+'%';const inS=S.rpm>=gd.sMin&&S.rpm<=gd.sMax;$('rpm-fill').style.background=inS?'linear-gradient(to top,#4dffb8,#66ffcc)':S.rpm>gd.sMax?'linear-gradient(to top,#ff8844,#ff4d4d)':'linear-gradient(to top,#4488cc,#4db8ff44)';$('energy-fill').style.height=(S.energy*100)+'%';const eBar=$('energy-bar-el');if(S.energy<.2)eBar.classList.add('low');else eBar.classList.remove('low');const pct=Math.round(S.incline*100);const icon=pct>2?'â–²':pct<-2?'â–¼':'â€”';$('h-incline').textContent=icon+' '+(pct>0?'+':'')+pct+'%';$('h-incline').style.color=pct>5?'#ff4d4d':pct>2?'#ffb84d':pct<-2?'#4dffb8':'#ffffff44';if(S.combo>1){$('combo-bar').textContent='COMBO Ã—'+S.combo;$('combo-bar').classList.add('on');$('combo-bar').style.color=S.combo>=20?'#ff4d8b':S.combo>=10?'#ffb84d':'#4dffb8'}else $('combo-bar').classList.remove('on');if(S.pedalInterval>0){const ideal=60000/gd.bpm,ratio=Math.min(1,ideal/Math.max(1,S.pedalInterval)),circ=276.5;$('pedal-progress').style.strokeDashoffset=circ-circ*ratio;$('pedal-progress').style.stroke=inS?'#4dffb8':S.rpm>gd.sMax?'#ff4d4d':'#4db8ff'}if(S.activePowerup){$('pu-icon').textContent=S.activePowerup.icon;$('pu-label').textContent=S.activePowerup.msg.split(' ').slice(1).join(' ');$('pu-timer').textContent=Math.ceil(S.powerupTimer)+'s';const pc='#'+S.activePowerup.color.toString(16).padStart(6,'0');$('pu-timer').style.color=pc;$('pu-label').style.color=pc;$('powerup-status').classList.add('show')}else $('powerup-status').classList.remove('show');const hint=$('shift-hint');const[oL,oH]=gd.optSpd;const inOptSpd=S.speed>=oL&&S.speed<=oH;if(hint._suppressed){hint.style.opacity=0}else{if(S.rpm>gd.sMax&&S.gear<S.maxGear){hint.textContent='â–² SHIFT UP';hint.style.color='#ff4d4d';hint.style.opacity=1}else if(S.rpm>gd.sMax&&S.gear>=S.maxGear){hint.textContent='â˜… MAX GEAR â€” HOLD RHYTHM';hint.style.color='#ffcc00';hint.style.opacity=.8}else if(S.rpm<gd.sMin*.7&&S.gear>1){hint.textContent='â–¼ SHIFT DOWN';hint.style.color='#4db8ff';hint.style.opacity=1}else if(S.incline>0.04&&S.speed<oL&&S.gear>1){hint.textContent='â–¼ DOWNSHIFT FOR CLIMB';hint.style.color='#ff884d';hint.style.opacity=1}else if(S.incline<-0.03&&S.speed>oH*.8&&S.gear<S.maxGear){hint.textContent='â–² UPSHIFT â€” DOWNHILL!';hint.style.color='#4dffb8';hint.style.opacity=.8}else if(!inOptSpd&&S.speed>5){if(S.speed<oL&&S.gear>1){hint.textContent='â–¼ GEAR TOO HIGH';hint.style.color='#ffb84d';hint.style.opacity=.8}else if(S.speed>oH&&S.gear<S.maxGear){hint.textContent='â–² GEAR TOO LOW';hint.style.color='#ffb84d';hint.style.opacity=.8}else hint.style.opacity=0}else hint.style.opacity=0}$('h-gear').style.color=inOptSpd?'#4dffb8':Math.abs(S.speed-(oL+oH)/2)>30?'#ff4d4d':'#ffb84d'}
let _lastFloatTime=0;
function floatText(t,c='#4dffb8'){
  const now=Date.now();if(now-_lastFloatTime<600)return; 
  _lastFloatTime=now;
  const f=$('float-text');f.textContent=t;f.style.color=c;f.classList.remove('show');void f.offsetWidth;f.classList.add('show');
  $('shift-hint').style.opacity=0;$('shift-hint')._suppressed=true;
  clearTimeout(f._t);f._t=setTimeout(()=>{f.classList.remove('show');$('shift-hint')._suppressed=false},900);
}
function toast(m){const t=$('toast');t.textContent=m;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2000)}
function showZone(z){$('z-name').textContent=z.name;$('z-name').style.color='#'+z.col.toString(16).padStart(6,'0');$('z-sub').textContent='ZONE '+(ZONES.indexOf(z)+1);const b=$('zone-banner');b.classList.add('show');setTimeout(()=>b.classList.remove('show'),3000)}
function flash(col='#ffffff'){const f=$('flash-overlay');f.style.background=col;f.style.opacity=.35;setTimeout(()=>f.style.opacity=0,80)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MULTIPLAYER LOGIC (LOBBY + GHOSTS) - PORT 8084 PATCHED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MP = {
  client: null,
  room: "RACE1",
  id: "RIDER_" + Math.floor(Math.random() * 9999),
  state: "DISCONNECTED", 
  players: {}, 
  lastSent: 0
};

const matHolo = new THREE.MeshBasicMaterial({ color: 0x00ffcc, wireframe: true, transparent:true, opacity:0.3 });

function initMP(roomCode) {
  MP.room = roomCode;
  
  // PATCH: Use Port 8084 for WSS (HTTPS compatible)
  // 8083 is WS, 8084 is WSS on broker.emqx.io
  try {
    MP.client = new Paho.MQTT.Client("broker.emqx.io", 8084, MP.id);
  } catch(e) {
    alert("Network Error: MQTT Blocked?");
    return;
  }

  MP.client.onConnectionLost = (o) => {
    console.log("MP Lost", o);
    if(MP.state === "LOBBY") toast("CONNECTION LOST");
  };
  MP.client.onMessageArrived = onMessage;
  
  MP.client.connect({
    onSuccess: () => {
      console.log("Connected to Broker");
      MP.client.subscribe("geargrinder/lob/" + MP.room);
      enterLobby();
    },
    onFailure: (e) => {
      alert("Cannot connect to Multiplayer Server (Firewall?). Error: " + e.errorMessage);
      $('start-btn').textContent = "ENTER LOBBY";
      $('start-btn').disabled = false;
    },
    useSSL: true // Required for GitHub Pages
  });
}

function sendMsg(type, data={}) {
  if (!MP.client || !MP.client.isConnected()) return;
  const payload = JSON.stringify({ ...data, type, id: MP.id });
  const m = new Paho.MQTT.Message(payload);
  m.destinationName = "geargrinder/lob/" + MP.room;
  MP.client.send(m);
}

function onMessage(msg) {
  let data;
  try { data = JSON.parse(msg.payloadString); } catch(e){ return; }
  if (data.id === MP.id) return; // Ignore self

  if (data.type === 'presence') {
    if (!MP.players[data.id]) {
      MP.players[data.id] = { name: data.id, ready: false };
      updateLobbyUI();
      sendMsg('presence'); 
    }
  } else if (data.type === 'start_race') {
    const delay = data.startAt - Date.now();
    if (delay > 0) beginCountdown(delay);
    else beginCountdown(0);
  } else if (data.type === 'pos') {
    updateOpponent(data);
  }
}

function enterLobby() {
  MP.state = "LOBBY";
  $('start-screen').style.display='none';
  $('lobby-screen').classList.add('show');
  $('lobby-room-display').innerText = "ROOM: " + MP.room;
  
  sendMsg('presence');
  MP.players[MP.id] = { name: MP.id + " (YOU)", ready: true };
  updateLobbyUI();
  
  setInterval(() => {
    if(MP.state === "LOBBY") sendMsg('presence');
  }, 2000);
}

function updateLobbyUI() {
  const list = $('lobby-list');
  list.innerHTML = '';
  Object.values(MP.players).forEach(p => {
    const div = document.createElement('div');
    div.className = 'lobby-player' + (p.name.includes('YOU') ? ' me' : '');
    div.innerHTML = `<strong>${p.name}</strong><span class="status">READY</span>`;
    list.appendChild(div);
  });
}

// Start Race Trigger
$('lobby-start-btn').onclick = () => {
  initA(); // Ensure audio context is ready
  const startTimestamp = Date.now() + 3000;
  // Send network signal
  sendMsg('start_race', { startAt: startTimestamp });
  // Start locally immediately (fail-safe if network drops)
  beginCountdown(3000);
};

function beginCountdown(ms) {
  if(MP.state === "COUNTDOWN" || MP.state === "RACING") return; // Prevent double trigger
  MP.state = "COUNTDOWN";
  $('lobby-screen').classList.remove('show');
  const overlay = $('countdown-overlay');
  overlay.style.display = 'flex';
  
  let sec = Math.ceil(ms/1000);
  overlay.innerText = sec;
  
  const timer = setInterval(() => {
    ms -= 100;
    const newSec = Math.ceil(ms/1000);
    if(newSec < sec) {
      sec = newSec;
      overlay.innerText = sec > 0 ? sec : "GO!";
      tone(sec>0?400:800, 0.1, 'square');
    }
    if (ms <= 0) {
      clearInterval(timer);
      setTimeout(() => overlay.style.display='none', 500);
      startGame();
    }
  }, 100);
}

function startGame() {
  MP.state = "RACING";
  S.started = true;
  $('hud').style.display='block';
  reset();
}

function updateOpponent(data) {
  if (!MP.players[data.id]) MP.players[data.id] = { mesh: null };
  let opp = MP.players[data.id];

  if (!opp.mesh) {
    const g = bikeGrp.clone();
    g.traverse(o => {
      if(o.isMesh) {
          o.material = matHolo;
          o.castShadow = false;
          o.receiveShadow = false;
      }
      if(o.isLight || o.isCamera) o.visible = false;
    });
    scene.add(g);
    opp.mesh = g;
  }
  opp.targetDist = data.d;
  opp.laneX = data.x;
  opp.mesh.visible = true;
  opp.lastUpd = Date.now();
}

function mpLoop(dt) {
  if (MP.state !== "RACING") return;

  const now = Date.now();
  if (now - MP.lastSent > 100) {
    sendMsg('pos', { d: Math.floor(S.distance), x: S.laneX });
    MP.lastSent = now;
  }

  Object.values(MP.players).forEach(opp => {
    if (!opp.mesh) return;
    if (now - opp.lastUpd > 5000) { opp.mesh.visible = false; return; }

    const relZ = -(opp.targetDist - S.distance);
    if (relZ > -200 && relZ < 50) {
       opp.mesh.visible = true;
       // Approximate World Z for curve calculation based on visual offset
       const oppWorldZ = S._worldZ - (opp.targetDist - S.distance); 
       
       // Lateral Position with Interpolation
       const curveX = getCurveX(oppWorldZ);
       opp.mesh.position.x = opp.mesh.position.x + ((curveX + opp.laneX) - opp.mesh.position.x) * dt * 5;
       
       // Longitudinal Position
       const visualZ = -(opp.targetDist - S.distance);
       opp.mesh.position.z += (visualZ - opp.mesh.position.z) * dt * 5;
       
       opp.mesh.position.y = 0;
       
       // Rotation
       const cd = getCurveDeriv(oppWorldZ);
       opp.mesh.rotation.z = -cd * 0.08;
       opp.mesh.rotation.x = -getHeightDeriv(oppWorldZ) * 1.5;

       // Spin wheels
       opp.mesh.children[0].children[0].rotation.x += dt * 10;
       opp.mesh.children[0].children[1].rotation.x += dt * 10;

    } else {
       opp.mesh.visible = false;
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RPM_GAIN=0.09;
function pedal(){if(!S.alive||!S.started)return;if(S.energy<=0&&S.speed<2){floatText('NO ENERGY!','#ff4d4d');return}initA();sndPedal();const now=performance.now();if(S.lastPedal>0)S.pedalInterval=now-S.lastPedal;S.lastPedal=now;S.pedalCount++;const gd=GEARS[S.gear];S.rpm=Math.min(1,S.rpm+RPM_GAIN);const inS=S.rpm>=gd.sMin&&S.rpm<=gd.sMax;

  let cost=0.008+gd.ratio*0.012;
  if(inS) cost*=0.25;
  else if(S.rpm>gd.sMax) cost*=1.5+((S.rpm-gd.sMax)*4); 
  else cost*=1.3+((gd.sMin-S.rpm)*3); 

  const[optLo,optHi]=gd.optSpd;
  const optRange=optHi-optLo;
  if(S.speed>=optLo&&S.speed<=optHi){
    cost*=0.35;
  } else {
    const dist=S.speed<optLo?(optLo-S.speed)/optRange:(S.speed-optHi)/optRange;
    cost*=(1.5+dist*dist*4);
    if(S.speed<optLo&&S.gear>3) cost*=(1+Math.min(2,(S.gear-3)*0.25));
  }

  if(S.incline>0) cost*=(1+S.incline*6);
  else cost*=Math.max(0.15,1+S.incline*3); 

  if(S.activePowerup&&S.activePowerup.type==='GRAVITY') cost*=0.25;
  S.energy=Math.max(0,S.energy-cost);

  if(cost>0.04&&S.pedalCount>5&&S.combo<2){
    if(S.speed<optLo&&S.gear>1) floatText('âš  GEAR TOO HIGH â€” BURNING ENERGY','#ff4d4d');
    else if(S.speed>optHi&&S.gear<S.maxGear) floatText('âš  GEAR TOO LOW â€” WASTING POWER','#ff884d');
  }

  let accel=inS?2.0:1.4;
  if(S.energy<0.15) accel*=(0.3+S.energy*4.5);
  if(S.energy<=0) accel*=0.1;
  if(S.activePowerup&&S.activePowerup.type==='SPEED') accel*=1.4;
  const topSpd=gd.top*(S.activePowerup&&S.activePowerup.type==='SPEED'?1.3:1);
  const incF=Math.max(0.1,1-S.incline*5);
  const headroom=Math.max(0,(topSpd-S.speed)/topSpd);
  const dimReturn=0.4+headroom*0.6;
  S.speed=Math.min(topSpd,S.speed+gd.ratio*accel*incF*dimReturn);

  if(inS){S.combo++;if(S.combo>S.bestCombo)S.bestCombo=S.combo;const sm=S.activePowerup&&S.activePowerup.type==='SCORE'?2:1;S.score+=(2+S.combo*.4)*S.gear*sm;$('h-score').classList.add('bump');setTimeout(()=>$('h-score').classList.remove('bump'),100);if(S.combo===5){floatText('ğŸ”¥ ON FIRE!','#ffb84d');sndCombo()}if(S.combo===10){floatText('âš¡ UNSTOPPABLE!','#ff4d8b');sndCombo()}if(S.combo===25){floatText('ğŸ’€ LEGENDARY!','#aa44ff');sndCombo()}}else{if(S.combo>=5)floatText('COMBO LOST','#ff4d4d');if(S.rpm>gd.sMax&&S.combo<2){if(S.gear>=S.maxGear)floatText('MAX RPM â€” HOLD STEADY','#ffcc00');else floatText('RPM TOO HIGH â€” SHIFT UP!','#ff884d')}else if(S.rpm<gd.sMin&&S.combo<2&&S.pedalCount>3)floatText('RPM TOO LOW','#4db8ff');S.combo=0}crankGrp.rotation.x+=Math.PI/3;$('pedal-btn').classList.add('pressed');setTimeout(()=>$('pedal-btn').classList.remove('pressed'),70)}

function shift(dir){if(!S.alive||!S.started)return;initA();const ng=Math.max(1,Math.min(S.maxGear,S.gear+dir));if(ng===S.gear)return;const el=$('h-gear');el.classList.remove('shift-up','shift-down');void el.offsetWidth;el.classList.add(dir>0?'shift-up':'shift-down');const oldR=S.rpm;S.gear=ng;if(ng>S.topGearUsed)S.topGearUsed=ng;sndShift(dir>0);
  S._fovKick=dir>0?-Math.min(10,2+S.speed*.06):Math.min(7,1.5+S.speed*.04);
  const gd=GEARS[S.gear];
  if(oldR>=gd.sMin*.75&&oldR<=gd.sMax*1.2){
    floatText('âš¡ PERFECT SHIFT!','#4dffb8');sndPerfect();
    S.score+=120*S.gear;S.stats.perfects++;
    S.rpm=dir>0?S.rpm*.80:Math.min(.95,S.rpm*1.3);
    S._fovKick*=2.0; 
  }else{
    S.rpm=dir>0?S.rpm*.65:Math.min(.95,S.rpm*1.25);
  }
  updHUD();
}
function changeLane(dir){if(!S.alive||!S.started)return;const nL=S.lane+dir;if(nL>=0&&nL<LANES.length)S.lane=nL}
function die(){S.alive=false;sndCrash();S.shake=1.2;flash('#ff0000');if(windGain)windGain.gain.setTargetAtTime(0,actx.currentTime,.1);const isNew=S.score>HS;if(isNew){HS=Math.floor(S.score);localStorage.setItem('gg_hs3',HS)}let grade='D';if(S.score>200000)grade='S+';else if(S.score>150000)grade='S';else if(S.score>100000)grade='A+';else if(S.score>75000)grade='A';else if(S.score>50000)grade='B+';else if(S.score>30000)grade='B';else if(S.score>15000)grade='C';setTimeout(()=>{$('go-grade').textContent=grade;$('go-grade').style.color=grade[0]==='S'?'#ff4d8b':grade[0]==='A'?'#4dffb8':grade==='B+'||grade==='B'?'#ffb84d':'#ffffff88';$('go-dist').textContent=Math.floor(S.distance)+'m';$('go-maxspd').textContent=Math.floor(S.maxSpeed)+' km/h';$('go-perfect').textContent=S.stats.perfects;$('go-cliffs').textContent=S.stats.cliffs;$('go-topgear').textContent=S.topGearUsed+'/12';$('go-combo').textContent=S.bestCombo+'Ã—';$('go-score').textContent=Math.floor(S.score).toLocaleString();$('go-hs').textContent='HIGH SCORE: '+HS.toLocaleString();$('go-new').style.display=isNew?'block':'none';$('go-screen').classList.add('show');$('hud').style.display='none';setTimeout(()=>$('go-grade').classList.add('pop'),200);document.querySelectorAll('.go-stat').forEach((el,i)=>setTimeout(()=>el.classList.add('show'),350+i*80))},900)}
function reset(){Object.assign(S,{score:0,distance:0,speed:0,maxSpeed:0,gear:1,topGearUsed:1,rpm:0,combo:0,bestCombo:0,energy:1,alive:true,lastPedal:0,pedalInterval:0,pedalCount:0,difficulty:1,zone:0,shake:0,frame:0,incline:0,lane:1,laneX:0,activePowerup:null,powerupTimer:0,invulnerable:0,_deathTimer:0,_renderIncline:0,_camIncline:0,_worldZ:0,_fovKick:0,_cliffTension:0,_cliffTarget:0,_terrainFeel:0,stats:{perfects:0,cliffs:0,powerups:0}});bikeGrp.position.set(0,0,0);bikeGrp.rotation.set(0,0,0);obstacles.forEach(o=>scene.remove(o));obstacles.length=0;powerupObjs.forEach(p=>scene.remove(p));powerupObjs.length=0;
for(let i=0;i<sceneryItems.length;i++){sceneryItems[i].userData._localZ=-i*SCENERY_SPACING-Math.random()*2;sceneryItems[i].position.z=sceneryItems[i].userData._localZ}
$('go-screen').classList.remove('show');$('go-grade').classList.remove('pop');document.querySelectorAll('.go-stat').forEach(el=>el.classList.remove('show'));$('hud').style.display='block';nextCliffDist=150;nextPowerupDist=80;const z=ZONES[0];scene.fog.color.set(z.fog);renderer.setClearColor(z.fog);pLight.color.set(z.col)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _spaceDown=false;
document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();if(!_spaceDown){_spaceDown=true;pedal()}}if(e.code==='ArrowUp'){e.preventDefault();shift(1)}if(e.code==='ArrowDown'){e.preventDefault();shift(-1)}if(e.code==='ArrowLeft'){e.preventDefault();changeLane(-1)}if(e.code==='ArrowRight'){e.preventDefault();changeLane(1)}});
document.addEventListener('keyup',e=>{if(e.code==='Space')_spaceDown=false});
$('pedal-btn').addEventListener('pointerdown',e=>{e.preventDefault();pedal()});
let lastScroll=0;window.addEventListener('wheel',e=>{const n=performance.now();if(n-lastScroll<130)return;lastScroll=n;shift(e.deltaY<0?1:-1)},{passive:true});
let tsx=0,tsy=0;document.addEventListener('touchstart',e=>{tsx=e.touches[0].clientX;tsy=e.touches[0].clientY},{passive:true});
document.addEventListener('touchmove',e=>{if(S.started)e.preventDefault();const dx=e.touches[0].clientX-tsx,dy=e.touches[0].clientY-tsy;if(Math.abs(dx)>Math.abs(dy)){if(Math.abs(dx)>28){changeLane(dx>0?1:-1);tsx=e.touches[0].clientX}}else{if(Math.abs(dy)>28){shift(dy<0?1:-1);tsy=e.touches[0].clientY}}},{passive:false});

$('start-btn').onclick=()=>{
  initA();
  const btn = $('start-btn');
  btn.textContent = "CONNECTING...";
  btn.disabled = true;
  
  const room = $('room-input').value;
  if(room.length > 0) initMP(room);
  else initMP("RACE1");
};

$('retry-btn').onclick=()=>{reset();S.started=true};
$('share-btn').onclick=()=>{const t='ğŸš´ GEAR GRINDER ULTIMATE\n'+$('go-grade').textContent+' Grade | '+Math.floor(S.score).toLocaleString()+' pts\n'+Math.floor(S.distance)+'m | '+Math.floor(S.maxSpeed)+' km/h';if(navigator.share)navigator.share({title:'GEAR GRINDER',text:t}).catch(()=>{});else navigator.clipboard.writeText(t).then(()=>toast('COPIED!'))};
window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastT=performance.now(),nextCliffDist=150,nextPowerupDist=80;
const _tc=new THREE.Color();

function update(dt){
  if(!S.alive||!S.started)return;
  
  mpLoop(dt);

  S.frame++;
  const targetX=LANES[S.lane];S.laneX+=(targetX-S.laneX)*dt*8;
  const gd=GEARS[S.gear];
  const gearEffort=S.gear<=6?1.0:1.0+(S.gear-6)*0.08;
  const uphillRpmPenalty=S.incline>0?1+S.incline*20:1;
  S.rpm=Math.max(0,S.rpm-dt*(0.06+S.rpm*0.30)*gearEffort*uphillRpmPenalty);

  S.incline=getHeightDeriv(S._worldZ);
  S._renderIncline+=(S.incline-S._renderIncline)*dt*2.5;
  S._camIncline+=(S._renderIncline-S._camIncline)*dt*0.8;

  const incDrag=S.incline>0?S.incline*20:0;
  const downBoost=S.incline<0?-S.incline*12:0;
  S.speed=Math.max(0,S.speed-dt*(0.12+S.speed*S.speed*0.00035+S.speed*0.008+incDrag)+dt*downBoost);
  const ts=(performance.now()-S.lastPedal)/1000;
  let regen=0.015+(ts>0.6?0.05:0)+(S.incline<0?-S.incline*.6:0);
  if(S.speed>5){const gd2=GEARS[S.gear];const[oL,oH]=gd2.optSpd;if(S.speed<oL-5||S.speed>oH+10){const mismatch=S.speed<oL?(oL-S.speed)/15:(S.speed-oH)/15;regen-=Math.min(0.06,mismatch*0.035)}}
  S.energy=Math.min(1,S.energy+dt*regen);
  if(S.speed>S.maxSpeed)S.maxSpeed=S.speed;
  const mz=S.speed*dt*.5;S.distance+=mz;S._worldZ-=mz;
  const sm=S.activePowerup&&S.activePowerup.type==='SCORE'?2:1;
  S.score+=mz*.5*(1+S.combo*.1)*sm;S.difficulty=1+S.distance/700;
  if(S.activePowerup){S.powerupTimer-=dt;if(S.powerupTimer<=0){S.activePowerup=null;toast('POWERUP EXPIRED')}}
  if(S.invulnerable>0)S.invulnerable-=dt;

  for(let i=ZONES.length-1;i>=0;i--){if(S.distance>=ZONES[i].dist){if(S.zone!==i){S.zone=i;showZone(ZONES[i])}const z=ZONES[i];_tc.set(z.fog);scene.fog.color.lerp(_tc,dt*.5);renderer.setClearColor(scene.fog.color);_tc.set(z.col);pLight.color.lerp(_tc,dt*.5);_tc.set(z.gnd);gndMat.color.lerp(_tc,dt*.5);
  const tR=new THREE.Color(z.road);seamRoadMat.color.lerp(tR,dt*.3);
  _tc.set(z.line).multiplyScalar(1.2);curbMat.color.lerp(_tc,dt*.2);break}}
  const baseFog=Math.max(0.0006,0.003-Math.min(0.0024,S.speed*0.000025));
  const dlFog=Math.max(0,-S._terrainFeel)*0.002; 
  const clFog=S._cliffTension*0.004;              
  const tf=Math.max(0.0002,baseFog-dlFog+clFog);
  scene.fog.density+=(tf-scene.fog.density)*dt*1.5;

  if(S.distance>=nextCliffDist){const c=mkCliff();c.position.z=-ROAD_DRAW_DIST;c.userData.reqSpeed=Math.min(90,18+S.difficulty*6+Math.random()*8);scene.add(c);obstacles.push(c);nextCliffDist=S.distance+120+Math.random()*(200-Math.min(120,S.difficulty*18))}
  if(S.distance>=nextPowerupDist){const safe=!obstacles.some(o=>o.position.z>-ROAD_DRAW_DIST-20&&o.position.z<-ROAD_DRAW_DIST+20);if(safe){const ty=POWERUPS[Math.floor(Math.random()*POWERUPS.length)].type;const p=mkPU(ty);p.position.set(LANES[Math.floor(Math.random()*3)],1,-ROAD_DRAW_DIST);p.userData._laneOffset=p.position.x;scene.add(p);powerupObjs.push(p)}nextPowerupDist=S.distance+100+Math.random()*80+S.difficulty*8}

  const bikeCX=getCurveX(S._worldZ);
  const rawFeel=Math.max(-1,Math.min(1,S._renderIncline*8));
  S._terrainFeel+=(rawFeel-S._terrainFeel)*dt*2;
  const cf=S._cliffTension;

  const recycleZ=RSL*2;
  for(let i=0;i<roadSegs.length;i++){
    const seg=roadSegs[i];seg.position.z+=mz;
    if(seg.position.z>recycleZ){let mn=Infinity;for(let j=0;j<roadSegs.length;j++)if(roadSegs[j].position.z<mn)mn=roadSegs[j].position.z;seg.position.z=mn-RSL}
    seg.position.x=getCurveX(S._worldZ+seg.position.z);
    seg.position.y=0;
    seg.rotation.x=0;seg.rotation.y=0;seg.rotation.z=0;
  }
  const downScale=Math.max(0,-S._terrainFeel)*0.8;  
  const cliffNarrow=cf*0.4;                          
  const targetRoadScale=1.0+downScale-cliffNarrow;
  roadGrp.scale.x+=(targetRoadScale-roadGrp.scale.x)*dt*2;

  seamRoad.scale.x+=(targetRoadScale-seamRoad.scale.x)*dt*2;
  seamRoad.position.x=camera.position.x;
  seamRoad.position.z=camera.position.z-ROAD_DRAW_DIST*0.5;
  seamRoad.position.y=0;

  const scenRecycleZ=25;
  for(let i=0;i<sceneryItems.length;i++){
    const it=sceneryItems[i];it.position.z+=mz;
    if(it.position.z>scenRecycleZ){let mn=Infinity;for(let j=0;j<sceneryItems.length;j++)if(sceneryItems[j].position.z<mn)mn=sceneryItems[j].position.z;it.position.z=mn-SCENERY_SPACING-Math.random()*2}
    it.position.x=getCurveX(S._worldZ+it.position.z)+it.userData._side*it.userData._sideOffset*roadGrp.scale.x;
    it.position.y=0;
  }

  let warn=false;
  S._cliffTarget=0; 
  for(let i=obstacles.length-1;i>=0;i--){
    const o=obstacles[i];o.position.z+=mz;
    o.position.x=getCurveX(S._worldZ+o.position.z);
    o.position.y=0;
    if(o.position.z>-60&&o.position.z<-4&&!o.userData.cleared){
      warn=true;
      const distM=Math.floor(-o.position.z);
      const spd=Math.floor(o.userData.reqSpeed);
      const have=Math.floor(S.speed);
      const ok=have>=spd;
      $('cliff-warn').innerHTML=(ok?'âœ“':'âš ')+' CLIFF '+distM+'m â€” NEED '+spd+' KM/H '+(ok?'âœ“':'âš ');
      $('cliff-warn').style.color=ok?'#4dffb8':'#ff6633';
      const proximity=Math.max(0,1-(o.position.z+4)/(-56));
      S._cliffTarget=Math.max(S._cliffTarget,proximity*proximity);
    }
    if(o.position.z>-o.userData.gap/2&&o.position.z<o.userData.gap/2&&!o.userData.cleared){
      if(S.speed>=o.userData.reqSpeed){
        o.userData.cleared=true;const bonus=Math.floor(200*S.difficulty);
        S.score+=bonus;S.stats.cliffs++;
        floatText('CLEARED! +'+bonus,'#4dffb8');emit(0,2,0,25,0x4dffb8);
        tone(600,.1,'sine');tone(900,.2,'sine');
        S._fovKick=-Math.min(14,4+S.speed*.08);
      }else{die();return}
    }
    if(o.position.z>20){scene.remove(o);obstacles.splice(i,1)}
  }
  $('cliff-warn').classList.toggle('show',warn);

  const bikeCXL=bikeCX+S.laneX;
  for(let i=powerupObjs.length-1;i>=0;i--){
    const p=powerupObjs[i];p.position.z+=mz;
    p.position.x=getCurveX(S._worldZ+p.position.z)+(p.userData._laneOffset||0);
    p.rotation.y+=dt*2;p.userData.bob+=dt*4;
    p.position.y=1+Math.sin(p.userData.bob)*.2;
    if(Math.abs(p.position.z)<1.5&&Math.abs(p.position.x-bikeCXL)<1.2){
      const def=p.userData.def;S.activePowerup=def;S.powerupTimer=def.dur;S.stats.powerups++;
      if(p.userData.pType==='ENERGY'){S.energy=Math.min(1,S.energy+.5);S.invulnerable=.5}
      floatText(def.msg,'#'+def.color.toString(16).padStart(6,'0'));sndPowerup();emit(p.position.x,1,0,30,def.color);
      scene.remove(p);powerupObjs.splice(i,1)}
    else if(p.position.z>10){scene.remove(p);powerupObjs.splice(i,1)}
  }

  if(S.speed>5)emit(bikeGrp.position.x,.1,1.2,1,0x888888,1);
  const dlF=Math.max(0,-S._terrainFeel);
  $('speed-lines').style.opacity=Math.min(1,Math.max(0,(S.speed-40)/60)+dlF*0.8);
  $('vignette').style.opacity=1+S._cliffTension*0.6;

  frontW.rotation.x+=S.speed*.3*dt;rearW.rotation.x+=S.speed*.3*dt;
  crankGrp.rotation.x+=S.rpm*dt*5;chainring.rotation.x+=S.rpm*dt*5;sprocket.rotation.x+=S.rpm*dt*5*gd.ratio;
  bikeGrp.position.x=bikeCX+S.laneX;
  bikeGrp.position.y=Math.sin(S.frame*.12)*.012*Math.min(1,S.speed/10);
  bikeGrp.rotation.x+=(-S._renderIncline*1.5-bikeGrp.rotation.x)*dt*3;
  const bcd=getCurveDeriv(S._worldZ);
  bikeGrp.rotation.z=-bcd*0.08*Math.min(1,S.speed/30);
  bikeGrp.rotation.y=(targetX-S.laneX)*0.15;

  const pa=crankGrp.rotation.x,br=Math.sin(S.frame*.04)*.005,sc=Math.min(.20,S.speed*.0025);
  const hillLean=S._renderIncline*2.5;
  spineGrp.rotation.x=-.65-sc+br-hillLean*0.3;
  neckGrp.rotation.x=-spineGrp.rotation.x*.5-.1;
  headGrp.rotation.x=.15+sc*.3+hillLean*0.1;
  if(S.rpm>.5)headGrp.rotation.z=Math.sin(pa)*.015*S.rpm;else headGrp.rotation.z*=.9;
  const lP=pa,rP=pa+Math.PI;
  const legAmp=0.55+Math.max(0,hillLean)*0.15;
  lLeg.rotation.x=Math.sin(lP)*legAmp+.35;lLeg.userData.knee.rotation.x=-(Math.abs(Math.cos(lP))*.9+.45);
  rLeg.rotation.x=Math.sin(rP)*legAmp+.35;rLeg.userData.knee.rotation.x=-(Math.abs(Math.cos(rP))*.9+.45);
  const aw=Math.sin(pa*.5)*.04,spR=S.rpm>.6?Math.sin(pa)*.035:0;
  lArm.rotation.x=-1.1-sc*.5+aw+spR-hillLean*0.2;lArm.rotation.z=.15;lArm.userData.elbow.rotation.x=.6+sc*.8;
  rArm.rotation.x=-1.1-sc*.5-aw-spR-hillLean*0.2;rArm.rotation.z=-.15;rArm.userData.elbow.rotation.x=.6+sc*.8;
  const swayAmp=S.rpm>.4?Math.min(1,S.rpm)*(1+Math.max(0,hillLean)*0.8):0;
  if(swayAmp>0){const rk=Math.sin(pa)*.025*swayAmp;spineGrp.rotation.z=rk;hipGrp.rotation.z=rk*.3}else{spineGrp.rotation.z*=.92;hipGrp.rotation.z*=.92}

  camera.position.x=bikeGrp.position.x;
  const tf2=S._terrainFeel; 
  const downF=Math.max(0,-tf2);  
  const upF=Math.max(0,tf2);     

  const camY=3.5 + S.speed*.008 + downF*9 - upF*1.5 - cf*1.5;
  camera.position.y+=(camY-camera.position.y)*dt*2;

  const camZ=7.5 - S.speed*.025 + downF*14 - cf*4 + S._fovKick*0.3;
  camera.position.z+=(camZ-camera.position.z)*dt*1.5;

  if(S.shake>0){camera.position.x+=(Math.random()-.5)*S.shake;camera.position.y+=(Math.random()-.5)*S.shake*.7;S.shake*=.88;if(S.shake<.01)S.shake=0}

  const lookY=1.0 - downF*4 + cf*2;
  camera.lookAt(camera.position.x, lookY, -3);

  const baseFov=60 + S.speed/100*12;
  const terrainFov= downF*35 - upF*10 - cf*14;
  const targetFov=baseFov + terrainFov + S._fovKick;
  const clampedFov=Math.max(44, Math.min(110, targetFov));
  camera.fov+=(clampedFov-camera.fov)*dt*2;
  camera.updateProjectionMatrix();
  S._fovKick*=1-dt*1.5;
  S._cliffTension+=(S._cliffTarget-S._cliffTension)*dt*2;

  sun.position.set(8,18,bikeGrp.position.z+5);sun.target.position.set(0,0,bikeGrp.position.z);
  pLight.position.set(bikeGrp.position.x,3,bikeGrp.position.z);

  const tt=$('terrain-tint');
  if(S._cliffTension>0.05){
    tt.style.background='radial-gradient(ellipse at 50% 70%,#ff330010 0%,#ff110020 100%)';
    tt.style.opacity=Math.min(1,S._cliffTension*1.5);
  }else if(S._terrainFeel<-0.15){
    tt.style.background='radial-gradient(ellipse at 50% 30%,#2266ff08 0%,#0044aa10 60%,transparent 100%)';
    tt.style.opacity=Math.min(1,-S._terrainFeel);
  }else if(S._terrainFeel>0.15){
    tt.style.background='radial-gradient(ellipse at 50% 70%,#ff660008 0%,transparent 60%)';
    tt.style.opacity=Math.min(0.7,S._terrainFeel);
  }else{
    tt.style.opacity=0;
  }
  for(let i=0;i<PC;i++){const v=pVel[i];if(v.life>0){pPos[i*3]+=v.x*dt;pPos[i*3+1]+=v.y*dt;pPos[i*3+2]+=v.z*dt;if(v.kind===0)v.y-=5*dt;v.life-=dt*(v.kind===1?1.5:2);if(v.life<=0)pPos[i*3+1]=-10}}pGeo.attributes.position.needsUpdate=true;
  gnd.position.z=camera.position.z-600;gnd.position.x=bikeCX;gnd.position.y=-0.1;
  updateWind();
  if(S.energy<=0&&S.speed<=0.5&&S.distance>30){S._deathTimer=(S._deathTimer||0)+dt;if(S._deathTimer>1.5)die()}else S._deathTimer=0;
  updHUD();
}
function loop(){requestAnimationFrame(loop);const now=performance.now(),dt=Math.min(.06,(now-lastT)/1000);lastT=now;update(dt);renderer.render(scene,camera)}
loop();
</script>
</body>
</html>
